<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§ß‰∫åÁ∂≤È†ÅË®≠Ë®à</title>
    <script src="../js/head.js"></script>


</head>


<body>
    <script src="../js/main.js"></script>
    <script>load_navbar("../web/")</script>
    <div class="cent">

        <div class="card col-12 col-md-9 col-lg-9 m-5 rounded shadow ">
            <div class="card-body " style="min-height: 70vh;">
                <div class="row">
                    <!-- <div class="col">
                        <label for="">Ë°ÄÈáè</label>
                        <div class="progress" style="height: 30px;  background-color: beige;">
                            <div class="progress-bar bg-danger " role="progressbar" style="width: 100%;" id="hp_bar">

                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <label for="">È≠îÂäõ</label>
                        <div class="progress" style="height: 30px;  background-color: beige;">
                            <div class="progress-bar bg-primary " role="progressbar" style="width: 100%;" id="mage_bar">

                            </div>
                        </div>
                    </div> -->
                    <!-- <div class="col">
                        <label for="">Á∂ìÈ©ó</label>
                        <div class="progress " style="height: 30px; background-color: beige;">
                            <div class="progress-bar bg-warning " role="progressbar" style="width: 0%;" id="exp_bar">
                                0%
                            </div>

                        </div>
                    </div> -->
                    <div class="col">
                        <label for="">Ë°ÄÈáè</label>
                        <div class="progress" style="height: 30px; background-color: beige; position: relative;">
                            <div class="progress-bar bg-danger" role="progressbar" id="hp_bar" style="height:100%;">
                            </div>
                            <span id="hp_text" style="
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    color:black;
    pointer-events: none;
  ">0/100</span>
                        </div>
                    </div>
                    <div class="col">
                        <label for="">È≠îÂäõ</label>
                        <div class="progress" style="height: 30px; background-color: beige; position: relative;">
                            <div class="progress-bar bg-primary" role="progressbar" id="mage_bar" style="height:100%;">
                            </div>
                            <span id="mage_text" style="
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    color:black;
    pointer-events: none;
  ">0/100</span>
                        </div>
                    </div>
                    <div class="col">
                        <label for="">Á∂ìÈ©ó</label>
                        <div class="progress" style="height: 30px; background-color: beige; position: relative;">
                            <div class="progress-bar bg-warning" role="progressbar" id="exp_bar" style="height:100%;">
                            </div>
                            <span id="exp_text" style="
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    color:black;
    pointer-events: none;
  ">0/100</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-danger" onclick="cleardata()">Âà™Èô§Ë≥áÊñô</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-auto">
                        <p>Á≠âÁ¥ö:<span id="lvl">1</span></p>
                    </div>
                    <div class="col-auto">
                        <p>ÊîªÊìäÂäõ:<span id="atk">1</span></p>
                    </div>
                    <div class="col-auto">
                        <p>Èò≤Á¶¶Âäõ:<span id="def">1</span></p>
                    </div>
                    <div class="col-auto">
                        <p>ÈáëÈå¢:<span id="coin">0</span></p>
                    </div>
                </div>
                <iframe src="" id="gameFrame" class="flex-fill" style="width:100%; height: 80%;; border:0;"></iframe>

                <!-- Modal Overlay -->
                <div id="inventoryOverlay" style="
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    justify-content:center;
    align-items:flex-start;
    padding-top:50px;
    z-index:1000;
">
                    <!-- Modal Content -->
                    <div style="
        position:relative; /* ÁÇ∫ÊåâÈàïÂÆö‰ΩçÂÅöÊ∫ñÂÇô */
        background:#fff;
        padding:20px;
        border-radius:10px;
        display:flex;
        gap:20px;
        min-width:400px;
        max-height:80%;
        overflow:auto;
    ">
                        <!-- ÈóúÈñâÊåâÈàï -->
                        <button id="closeInventory" class="btn btn-sm btn-secondary" style="
            position:absolute;
            top:10px;
            right:10px;
        " onclick="closeInventory()">X</button>

                        <!-- Ë£ùÂÇôÊ¨Ñ -->
                        <div id="equipmentPanel" style="width:150px; flex-shrink:0;">
                            <div id="weaponSlot"
                                style="border:1px solid #ccc; padding:8px; margin-bottom:10px; text-align:center; border-radius:5px; background:#f8f9fa;">
                            </div>
                            <div id="armorSlot"
                                style="border:1px solid #ccc; padding:8px; text-align:center; border-radius:5px; background:#f8f9fa;">
                            </div>
                        </div>

                        <!-- Áâ©ÂìÅÊ¨Ñ -->
                        <table id="inventoryTable" class="table" style="border-collapse:collapse; min-width:200px;">
                            <tr>
                                <th style="border-bottom:1px solid #000; text-align:left; padding:4px;">Áâ©ÂìÅ</th>
                                <th style="border-bottom:1px solid #000; text-align:left; padding:4px;">Êï∏Èáè</th>
                            </tr>
                        </table>
                    </div>
                </div>





            </div>
        </div>
        <div id="tooltip" style="
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 6px 10px;
    border-radius: 5px;
    pointer-events: none;
    display: none;
    font-size: 14px;
    z-index: 2000;
"></div>
        <!-- üèô ÂüéÂ∏ÇÊ®°ÂºèÊäÄËÉΩÈù¢ÊùøÔºàÈõôÊ¨ÑÔºâ -->
        <div id="citySkillOverlay" style="display:none; position:fixed; top:15%; left:50%; transform:translateX(-50%);
  background:rgba(40,40,40,0.95); color:white; padding:20px; border:2px solid #aaa;
  border-radius:10px; width:700px; height:70vh; overflow:hidden; z-index:1000;
  flex-direction:column;">
            <h3 style="margin-top:0; text-align:center;">ÊäÄËÉΩÁÆ°ÁêÜ</h3>
            <div style="display:flex; gap:20px; flex:1; overflow:hidden;">

                <!-- Â∑¶ÈÇäÔºöÁõÆÂâçÊà∞È¨•ÊäÄËÉΩÊ¨Ñ -->
                <div style="flex:1; border-right:1px solid #555; overflow-y:auto; padding-right:10px;">
                    <h4>ÁõÆÂâçÊà∞È¨•ÊäÄËÉΩÊ¨Ñ</h4>
                    <div id="battleSkillList"></div>
                </div>

                <!-- Âè≥ÈÇäÔºöÊâÄÊúâÂ∑≤Â≠∏ÊäÄËÉΩ -->
                <div style="flex:1; overflow-y:auto;">
                    <h4>ÂèØË®≠ÂÆöÊäÄËÉΩ</h4>
                    <div id="citySkillList"></div>
                </div>

            </div>
            <button onclick="closeCitySkill()" style="margin-top:10px; padding:6px 10px; border:none; border-radius:6px; cursor:pointer;
                 background:#555; color:white;">ÈóúÈñâ</button>
        </div>
        <!-- ‚öîÔ∏è Êà∞È¨•Ê®°ÂºèÊäÄËÉΩÊ¨Ñ -->
        <!-- ‚öîÔ∏è Êà∞È¨•ÊäÄËÉΩÂàó -->
        <div id="battleSkillBar" style="
  display:none;
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  gap:10px;
  background:rgba(20,20,20,0.8);
  padding:8px 12px;
  border-radius:10px;
  z-index:900;
  flex-direction:row;
  justify-content:center;
  align-items:center;
">
        </div>


    </div>

    <script>
        const exp_bar = document.getElementById("exp_bar");
        const exp_text = document.getElementById("exp_text");
        const hp_bar = document.getElementById("hp_bar");
        const hp_text = document.getElementById("hp_text");
        const mage_bar = document.getElementById("mage_bar");
        const mage_text = document.getElementById("mage_text");
        class Character {
            constructor(name, maxHP, maxMP) {
                this.name = name;
                this.maxHP = maxHP;
                this.currentHP = maxHP;
                this.maxMP = maxMP;
                this.currentMP = maxMP;
                this.exp = 0;
                this.maxExp = 100;
                this.lvl = 1;
                this.atk = 1;
                this.def = 1;
                this.coin = 0;
                this.tasks = [];
                this.inventory = [];
                this.equipment = {
                    weapon: null,
                    armor: null
                };
                this.img = "../img/ÁÉè‰∏Ä‰∏ÄÈòø‰∏Ä.png"
                this.train = 10

                this.talentSlots = [];
                this.talentEffect = {
                    expRate: 0,
                    coinBonus: 0,
                    trainBoost: 0,
                    atkPercent: 0,
                    defPercent: 0,
                    maxHP: 0
                }
                this.statPoints = 0;
                this.totalStatPoints = 0;
                this.statBonus = { atk: 0, def: 0, hp: 0, mp: 0 }; // È°çÂ§ñÂä†ÈªûÂä†Êàê
                this.skills = []
                this.equipSkills = []
            }
            takeDamage(amount) {
                this.currentHP -= amount;
                if (this.currentHP < 0) this.currentHP = 0;
            }

            heal(amount) {
                this.currentHP += amount;
                if (this.currentHP > this.maxHP) this.currentHP = this.maxHP;
            }

            useMP(amount) {
                this.currentMP -= amount;
                if (this.currentMP < 0) this.currentMP = 0;
            }


            gainExp(amount) {
                let leveledUp = false;
                const stats = calculateStats(this);
                const realAmount = Math.round(amount * stats.expRate);
                this.exp += realAmount;

                // notify(`Áç≤ÂæóÁ∂ìÈ©ó ${realAmount}ÔºÅ`, "#fff8d6");

                while (this.exp >= this.maxExp) {
                    this.exp -= this.maxExp;
                    this.maxExp = Math.round(this.maxExp + this.maxExp * 0.2);
                    this.lvl += 1;

                    this.currentHP = this.maxHP;
                    this.currentMP = this.maxMP;
                    this.maxHP += 10;
                    this.maxMP += 10;
                    this.atk += 1;
                    this.def += 1;
                    this.statPoints = (this.statPoints || 0) + 5;
                    leveledUp = true;
                }

                if (leveledUp) {
                    notify(`üéâ Á≠âÁ¥öÊèêÂçáËá≥ ${this.lvl}ÔºÅÁç≤Âæó 5 Â±¨ÊÄßÈªûÂèØÂàÜÈÖçÔºÅ`, "#d1ffd1");
                    savePlayer();

                    // ‚úÖ Ëã•ÁõÆÂâçÂú®„Äå‰∫∫Áâ©Âä†Èªû„ÄçÁï´Èù¢ÔºåÈáçÊñ∞ËºâÂÖ•Êï¥ÂÄãÁï´Èù¢
                    const iframe = document.getElementById('gameFrame');
                    const doc = iframe?.contentDocument || iframe?.contentWindow?.document;
                    if (doc && doc.querySelector("h1")?.innerText.includes("‰∫∫Áâ©Âä†Èªû")) {
                        parent.openStatPanel(); // üîÅ ÈáçÊñ∞ËºâÂÖ•Êï¥ÂÄãÈ†ÅÈù¢
                    }

                    refreshStatPanel(); // ‰øùÈö™Ë£úÊõ¥Êñ∞‰∏ÄÊ¨°
                }

                updateBars();
            }



            addItem(item) {
                // üß© Âæû itemDatabase ÂòóË©¶ÊâæÁâ©ÂìÅË≥áÊñô
                let base = itemDatabase[item.name];

                // üîç Ëã•Âú® itemDatabase Êâæ‰∏çÂà∞ ‚Üí ÂòóË©¶Âà§Êñ∑ÊòØÂê¶ÊòØÊäÄËÉΩÊõ∏
                if (!base) {
                    const maybeSkill = item.name.replace("Êõ∏", ""); // ÂéªÊéâ„ÄåÊõ∏„ÄçÂ≠ó
                    const skillData = skillDatabase[maybeSkill];

                    if (skillData) {
                        base = {
                            name: item.name,
                            type: "skillBook",
                            price: skillData.price || 100,
                            skillRef: maybeSkill,
                            desc: `ÂèØÂ≠∏ÊúÉÊäÄËÉΩÔºö${maybeSkill}Ôºà${skillData.desc}Ôºâ`,
                        };
                    }
                }

                // ‚ùå Â¶ÇÊûúÈÇÑÊòØÊ≤íÊâæÂà∞
                if (!base) {
                    notify(`‚ùå Ë≥áÊñôÂ∫´Ë£°Ê≤íÊúâ ${item.name}`, "#ffd1d1");
                    return;
                }

                // ===============================
                // üß™ „ÄêÊ∂àËÄóÂìÅ„ÄëÂèØÂ†ÜÁñä
                // ===============================
                if (base.type === "consumable") {
                    const existing = this.inventory.find(i => i.name === item.name);
                    if (existing) {
                        existing.quantity += item.quantity || 1;
                    } else {
                        this.inventory.push({
                            id: Date.now() + Math.random(),
                            name: item.name,
                            quantity: item.quantity || 1,
                            type: base.type,
                            price: base.price || 10,
                            effect: base.effect || null,
                            content: base.content || null
                        });
                    }
                }

                // ===============================
                // ‚öîÔ∏è „ÄêË£ùÂÇô„Äë‰∏çÂèØÂ†ÜÁñä
                // ===============================
                else if (base.type === "weapon" || base.type === "armor") {
                    this.inventory.push({
                        id: Date.now() + Math.random(),
                        name: item.name,
                        quantity: 1,
                        type: base.type,
                        price: base.price || 10,
                        atk: base.atk || 0,
                        def: base.def || 0,
                        enhancement: item.enhancement || 0,
                        content: base.content || null
                    });
                }

                // ===============================
                // üìò „ÄêÊäÄËÉΩÊõ∏„ÄëÁâπÊÆäÈÇèËºØ
                // ===============================
                else if (base.type === "skillBook") {
                    const existing = this.inventory.find(i => i.name === item.name);
                    if (existing) {
                        existing.quantity += item.quantity || 1;
                    } else {
                        this.inventory.push({
                            id: Date.now() + Math.random(),
                            name: base.name,
                            quantity: item.quantity || 1,
                            type: "skillBook",
                            price: base.price,
                            skillRef: base.skillRef,
                            desc: base.desc
                        });
                    }
                }

                // ===============================
                // üßæ „ÄêÂÖ∂‰ªñÈõúÈ†Ö„Äë
                // ===============================
                else {
                    this.inventory.push({
                        id: Date.now() + Math.random(),
                        name: item.name,
                        quantity: item.quantity || 1,
                        type: base.type || "misc",
                        price: base.price || 10,
                        content: base.content || null
                    });
                }

                // üíæ Â≠òÊ™î‰∏¶ÊèêÁ§∫
                savePlayer();
                notify(`üì¶ Áç≤ÂæóÁâ©ÂìÅÔºö${item.name}`, "#d1ffd1");
            }





            useItem(itemName, quantity = 1) {
                const item = this.inventory.find(i => i.name === itemName);
                if (!item) return notify(`Êâæ‰∏çÂà∞ ${itemName}`, "#ffd1d1");
                if (item.quantity < quantity) return notify(`${itemName} Êï∏Èáè‰∏çË∂≥`, "#ffd1d1");

                // ÂÑ™ÂÖàÊü•Áâ©ÂìÅË≥áÊñôÂ∫´
                let base = itemDatabase[item.name];

                // üîπ Ëã•Áâ©ÂìÅË≥áÊñôÂ∫´Ê≤íÊúâÔºåÂ∞±Ê™¢Êü•ÊäÄËÉΩÊõ∏
                if (!base && item.type === "skillBook") {
                    const skillName = item.skillRef;
                    const skillData = skillDatabase[skillName];
                    if (skillData) {
                        base = {
                            name: item.name,
                            type: "skillBook",
                            skillRef: skillName,
                            price: skillData.price,
                            desc: skillData.desc,
                        };
                    }
                }

                // Ëã•‰ªçÁÑ∂Ê≤íÊâæÂà∞ÔºåÊèêÁ§∫ÈåØË™§
                if (!base) {
                    notify(`${itemName} ‰∏çÂ≠òÂú®ÊñºË≥áÊñôÂ∫´`, "#ffd1d1");
                    return;
                }

                // üß™ Ê∂àËÄóÂìÅ
                if (base.type === 'consumable' && base.effect) {
                    if (base.effect.hp) {
                        this.heal(base.effect.hp * quantity);
                        notify(`‰ΩøÁî®‰∫Ü ${itemName}ÔºåÂõûÂæ© ${base.effect.hp * quantity} HP`, "#fff8d6");
                    }
                    if (base.effect.mp) {
                        this.currentMP = Math.min(this.maxMP, this.currentMP + base.effect.mp * quantity);
                        notify(`‰ΩøÁî®‰∫Ü ${itemName}ÔºåÂõûÂæ© ${base.effect.mp * quantity} MP`, "#fff8d6");
                    }

                    item.quantity -= quantity;
                    if (item.quantity <= 0)
                        this.inventory = this.inventory.filter(i => i.name !== itemName);
                }

                // ‚öôÔ∏è Ë£ùÂÇôÈ°û
                else if (base.type === 'weapon' || base.type === 'armor') {
                    this.equip(itemName);
                }

                // üìò ÊäÄËÉΩÊõ∏
                else if (base.type === "skillBook") {
                    const skillName = base.skillRef;
                    const skillData = skillDatabase[skillName];

                    if (!skillData) {
                        notify("ÈÄôÊú¨Êõ∏‰∏äÁöÑÂ≠ó‰Ω†Áúã‰∏çÊáÇ...", "#ffd1d1");
                        return;
                    }

                    const alreadyLearned = this.skills.some(s => s.name === skillName);
                    if (alreadyLearned) {
                        notify(`üìñ ‰Ω†Â∑≤Á∂ìÂ≠∏ÊúÉ ${skillName}ÔºåÊõ∏È†ÅÁôºÂÖâÂæåËá™ÂãïÂêà‰∏ä„ÄÇ`, "#fff8d6");
                        return; // ‚ùó ‰∏çÊ∂àËÄó
                    }

                    this.skills.push({ name: skillName, lvl: 1 });
                    notify(`üéâ Â≠∏ÊúÉÊñ∞ÊäÄËÉΩÔºö${skillName}ÔºÅ`, "#d1ffd1");

                    item.quantity -= 1;
                    if (item.quantity <= 0)
                        this.inventory = this.inventory.filter(i => i.name !== itemName);
                }

                savePlayer();
                updateBars();
            }





            removeItem(itemName) {
                this.inventory = this.inventory.filter(i => i.name !== itemName);
                savePlayer();
            }


            listItems() {
                console.log("=== Áâ©ÂìÅÊ¨Ñ ===");
                this.inventory.forEach(i => console.log(`${i.name} x${i.quantity}`));
            }

            equip(itemName) {
                const item = this.inventory.find(i => i.name === itemName);
                if (!item) return notify(`${itemName} ‰∏çÂ≠òÂú®ÊñºËÉåÂåÖ`, "#ffd1d1");

                const base = itemDatabase[item.name];
                if (!base) return notify(`${itemName} Ê≤íÊúâÂú®Ë≥áÊñôÂ∫´‰∏≠`, "#ffd1d1");

                if (base.type === 'weapon') {
                    this.equipment.weapon = { name: base.name, atk: base.atk + (item.enhancement || 0) };
                    notify(`Â∑≤Ë£ùÂÇô ${base.name}ÔºàÊîªÊìä +${base.atk}Ôºâ`, "#d1ffd1");
                } else if (base.type === 'armor') {
                    this.equipment.armor = { name: base.name, def: base.def + (item.enhancement || 0) };
                    notify(`Â∑≤Ë£ùÂÇô ${base.name}ÔºàÈò≤Á¶¶ +${base.def}Ôºâ`, "#d1ffd1");
                }

                savePlayer();
                updateBars();
            }

            unequip(slot) {
                if (slot === 'weapon' && this.equipment.weapon) {
                    notify(`Â∑≤Âç∏‰∏ã ${this.equipment.weapon.name}`, "#fff8d6");
                    this.equipment.weapon = null;
                } else if (slot === 'armor' && this.equipment.armor) {
                    notify(`Â∑≤Âç∏‰∏ã ${this.equipment.armor.name}`, "#fff8d6");
                    this.equipment.armor = null;
                }
                loadInventory();
                updateBars();
            }

        }

        const player = new Character("Player", 100, 50);

        const tasks = [
            { name: "Ë®é‰ºêÂè≤ËêäÂßÜ", count: 5, rewards: { coin: 100, exp: 200, items: ["Ëó•Ê∞¥"] } },
            { name: "Ë®é‰ºêÂì•Â∏ÉÊûó", count: 5, rewards: { coin: 100, exp: 400, items: ["‰∏≠ÂûãÂõûË°ÄËó•Ê∞¥", "‰∏≠ÂûãÈ≠îÂäõËó•Ê∞¥"] } },
            { name: "Ë®é‰ºêÈ™∑È´èÂÖµ", count: 5, rewards: { coin: 100, exp: 1000, items: ["ÂØ∂ÁÆ±", "ÁõæÁâå"] } }
        ];
        function generateEnemy() {
            const enemies = [
                { name: "Âè≤ËêäÂßÜ", img: '../img/Âè≤ËêäÂßÜ.png', hp: 30, atk: 5, def: 0, rewardExp: 40, rewardCoin: [5, 15], drops: ["Ëó•Ê∞¥", "ÈêµÂäç", "Áüõ", "ÁõæÁâå"], lvl: [1, 10] },
                { name: "Âì•Â∏ÉÊûó", img: '../img/Âì•Â∏ÉÊûó.png', hp: 60, atk: 15, def: 10, rewardExp: 80, rewardCoin: [10, 20], drops: ["ÊñßÂàÄ", "ÈéñÂ≠êÁî≤", "‰∏≠ÂûãÂõûË°ÄËó•Ê∞¥", "‰∏≠ÂûãÈ≠îÂäõËó•Ê∞¥"], lvl: [5, 20] },
                { name: "È™∑È´èÂÖµ", img: '../img/È™∑È´èÈ†≠.png', hp: 200, atk: 30, def: 20, rewardExp: 200, rewardCoin: [15, 25], drops: ["Á•ûÂäç", "ÈáëÈêòÁΩ©"], lvl: [10, 30] }
            ];
            let enemy = { ...enemies[Math.floor(Math.random() * enemies.length)] }
            let minLvl = enemy.lvl[0];
            let maxLvl = enemy.lvl[1];
            let lvl = Math.floor(Math.random() * (maxLvl - minLvl + 1)) + minLvl;
            enemy.hp += (lvl - 1) * 4
            enemy.atk += (lvl - 1) * 4
            enemy.def += (lvl - 1) * 4
            enemy.rewardExp += (lvl - 1) * 4
            enemy.lvl = lvl
            return enemy;
        }
        const shopItems = [
            { name: "Â∞èÂûãÂõûË°ÄËó•Ê∞¥", price: 50 },
            { name: "Â∞èÂûãÈ≠îÂäõËó•Ê∞¥", price: 50 },
            { name: "‰∏≠ÂûãÂõûË°ÄËó•Ê∞¥", price: 150 },
            { name: "‰∏≠ÂûãÈ≠îÂäõËó•Ê∞¥", price: 150 }
        ];
        const itemDatabase = {
            "Ëó•Ê∞¥": { rate: 50, price: 50, name: "Ëó•Ê∞¥", type: "consumable", effect: { hp: 40 } },
            "Â∞èÂûãÂõûË°ÄËó•Ê∞¥": { rate: 50, price: 50, name: "Â∞èÂûãÂõûË°ÄËó•Ê∞¥", type: "consumable", effect: { hp: 40 }, content: "ÂõûÂæ©40hp" },
            "Â∞èÂûãÈ≠îÂäõËó•Ê∞¥": { rate: 50, price: 50, name: "Â∞èÂûãÈ≠îÂäõËó•Ê∞¥", type: "consumable", effect: { hp: 40 }, content: "ÂõûÂæ©40mp" },
            "‰∏≠ÂûãÂõûË°ÄËó•Ê∞¥": { rate: 50, price: 100, name: "‰∏≠ÂûãÂõûË°ÄËó•Ê∞¥", type: "consumable", effect: { hp: 100 }, content: "ÂõûÂæ©100hp" },
            "‰∏≠ÂûãÈ≠îÂäõËó•Ê∞¥": { rate: 50, price: 100, name: "‰∏≠ÂûãÈ≠îÂäõËó•Ê∞¥", type: "consumable", effect: { hp: 100 }, content: "ÂõûÂæ©100mp" },
            "ÂØ∂ÁÆ±": { rate: 50, price: 400, name: "ÂØ∂ÁÆ±", type: "consumable", content: "ÊãøÂéªÂïÜÂ∫óË≥£ÂÄºÂÄãÂ•ΩÂÉπÈå¢" },
            "Áüõ": { rate: 30, price: 300, name: "Áüõ", type: "weapon", atk: 20, content: "+20ÊîªÊìäÂäõÔºåÈöîÂ£ÅËÄÅÁéãÈÉΩË™™ÊàëÁåõ" },
            "ÁõæÁâå": { rate: 30, price: 300, name: "ÁõæÁâå", type: "armor", def: 15, content: "+15Èò≤Á¶¶ÂäõÔºåÊúâÈªûÁ°¨Ëµ∑‰æÜ‰∫Ü" },
            "ÈêµÂäç": { rate: 30, price: 150, name: "ÈêµÂäç", type: "weapon", atk: 15, quantity: 1, content: "+15ÊîªÊìäÂäõÔºåÊúâÈªûÊîªÊìä‰ΩÜ‰∏çÂ§ö" },
            "ÊñßÂàÄ": { rate: 30, price: 550, name: "ÊñßÂàÄ", type: "weapon", atk: 60, quantity: 1, content: "+60ÊîªÊìäÂäõÔºåÂèØ‰ª•Á†çÊ®πÔºå‰πüÂèØ‰ª•Á†ç‰∫∫" },
            "Á•ûÂäç": { rate: 30, price: 5000, name: "Á•ûÂäç", type: "weapon", atk: 1000, quantity: 1, content: "+1000ÊîªÊìäÂäõÔºåÂ§©ÂïäÂ§ñÊéõÊ≠¶Âô®" },
            "ÈáëÈêòÁΩ©": { rate: 20, price: 5000, name: "ÈáëÈêòÁΩ©", type: "armor", def: 1000, quantity: 1, content: "+1000Èò≤Á¶¶ÂäõÔºåÂ§™Á°¨‰∫ÜÂêßÔºåÊ≤í‰∫∫ÊâìÂæóÁ©ø" },
            "ÈéñÂ≠êÁî≤": { rate: 20, price: 550, name: "ÈéñÂ≠êÁî≤", type: "armor", def: 60, quantity: 1, content: "+60Èò≤Á¶¶ÂäõÔºå‰ºº‰πéÂæàÂèØÈù†ÔºåÂàÄÊßçblue" },


        };
        // === Â§©Ë≥¶Ë≥áÊñôÂ∫´ ===
        const skillDatabase = {
            "ÁÅ´ÁêÉË°ì": { rate: 30, price: 500, mpCost: 10, power: 30, desc: "Â∞çÊïµ‰∫∫ÈÄ†ÊàêËá™Ë∫´ÊîªÊìäÂäõ100%+30 ÈªûÁÅ´ÁÑ∞ÂÇ∑ÂÆ≥", type: "attack" },
            "Ê≤ªÁôíË°ì": { rate: 30, price: 300, mpCost: 8, power: 25, desc: "ÊÅ¢Âæ©Ëá™Ë∫´ 10% HP", type: "heal" },
            "Âº∑Âåñ": { rate: 30, price: 300, mpCost: 12, power: 0, desc: "ÊèêÂçáÊîªÊìäÂäõ 20% ÊåÅÁ∫å 3 ÂõûÂêà", type: "buff" },
            "Âº±Âåñ": { rate: 30, price: 300, mpCost: 12, power: 0, desc: "ÂâäÂº±Â∞çÊñπÊîªÊìäÂäõ 20% ÊåÅÁ∫å 3 ÂõûÂêà", type: "debuff" },
            "ÂÜ∞ÂáçË°ì": { rate: 30, price: 300, mpCost: 12, power: 30, desc: "Â∞çÊïµ‰∫∫ÈÄ†ÊàêËá™Ë∫´ÊîªÊìäÂäõ100%+30 ÈªûÂÜ∞ÂáçÂÇ∑ÂÆ≥ ÂÜ∞Âáç 1 ÂõûÂêà", type: "control" },
        };
        const talents = [
            { name: "Âº∑Â£ØÈ´îÈ≠Ñ", desc: "ÊúÄÂ§ßÁîüÂëΩ +50", effect: { maxHP: "+50" } },
            { name: "Á≤æÊ∫ñÊâìÊìä", desc: "ÊîªÊìäÂäõ +10%", effect: { atkPercent: "*1.1" } },
            { name: "ÈãºÈêµÊÑèÂøó", desc: "Èò≤Á¶¶Âäõ +10%", effect: { defPercent: "*1.1" } },
            { name: "Âã§Â•ÆÂ≠∏ËÄÖ", desc: "Áç≤ÂæóÁ∂ìÈ©óÂÄº +20%", effect: { expRate: "*1.2" } },
            { name: "Â§©ÈÅ∏‰πã‰∫∫", desc: "Ë®ìÁ∑¥ÊïàÁéá +50%", effect: { trainBoost: "*1.5" } },
            { name: "Ë≤°Á•ûÈôÑÈ´î", desc: "Êà∞È¨•Áç≤ÂæóÈáëÂπ£ +20%", effect: { coinBonus: "*1.2" } },
            { name: "Âπ∏ÈÅãÂä†Ë≠∑", desc: "ÊéâÂØ∂Áéá +10%", effect: { dropRate: "*1.1" } },
            { name: "È≠îÊ≥ïÂ§ßÂ∏´", desc: "ÊúÄÂ§ßÈ≠îÂäõ +200", effect: { maxMP: "+200" } },
            { name: "Â∑®ÂäõÁ•ûËáÇ", desc: "ÊîªÊìä +25%ÔºåÈò≤Á¶¶ +10%", effect: { atkPercent: "*1.25", defPercent: "*1.1" } },
            { name: "‰øÆÁ∑¥ËÅñÈ´î", desc: "Áç≤ÂæóÁ∂ìÈ©óÂÄº+1000% +200", effect: { expRate: "*11" } },
        ];



        // === Ê†πÊìöÁ≠âÁ¥öÊ±∫ÂÆöÂ§©Ë≥¶Ê¨Ñ‰Ωç‰∏äÈôê ===
        function getTalentSlotLimit() {
            const lvl = player.lvl;
            if (lvl >= 50) return 6;
            if (lvl >= 40) return 5;
            if (lvl >= 30) return 4;
            if (lvl >= 20) return 3;
            if (lvl >= 10) return 2;
            return 1;
        }
        let stats = null;

        function notify(message, bg = "#fff8d6", duration = 2000) {
            // Ëã•Â≠òÂú® parent.notify ‰∏î‰∏çÊòØËá™Â∑±ÔºåÁõ¥Êé•ÂßîÊ¥æÁµ¶Áà∂Â±§
            if (window.parent && window.parent !== window && typeof window.parent.notify === "function") {
                window.parent.notify(message, bg, duration);
                return;
            }

            const doc = document.body ? document : window.parent.document;
            const existing = doc.getElementById("notifyBox");
            if (existing) existing.remove();

            const box = doc.createElement("div");
            box.id = "notifyBox";
            box.innerHTML = message;
            box.style.position = "fixed";
            box.style.top = "20px";
            box.style.right = "20px";
            box.style.padding = "12px 18px";
            box.style.borderRadius = "10px";
            box.style.background = bg;
            box.style.boxShadow = "0 0 10px rgba(0,0,0,0.2)";
            box.style.fontSize = "15px";
            box.style.zIndex = 9999;
            box.style.opacity = 0;
            box.style.transition = "opacity 0.4s ease";

            (doc.body || document.body).appendChild(box);
            setTimeout(() => (box.style.opacity = 1), 10);
            setTimeout(() => {
                box.style.opacity = 0;
                setTimeout(() => box.remove(), 500);
            }, duration);
        }



        function waitForJquery(cb) {
            if (window.jQuery) cb();
            else setTimeout(() => waitForJquery(cb), 50);
        }

        // === Â•óÁî®Â§©Ë≥¶ÊïàÊûúÔºà‰øÆÊ≠£ÁâàÔºâ===
        function applyTalentEffects() {
            // ÂàùÂßãÂåñÂä†ÊàêÂÄºÔºàÂÄçÁéáÂûãÁî® 0ÔºåÁµêÁÆóÊôÇÂÜçËΩâÊèõÁÇ∫ÁôæÂàÜÊØîÔºâ
            player.talentEffect = {
                expRate: 0,
                coinBonus: 0,
                trainBoost: 0,
                atkPercent: 0,
                defPercent: 0,
                maxHP: 0,
                dropRate: 0
            };

            // Èò≤ÂëÜÔºöÁ¢∫‰øùÊúâÂ§©Ë≥¶Ë≥áÊñô
            if (!Array.isArray(player.talentSlots) || player.talentSlots.length === 0) return;

            player.talentSlots.forEach(talent => {
                const effect = talent.effect;
                if (!effect) return;

                for (const [key, val] of Object.entries(effect)) {
                    if (typeof val !== "string" || val.length < 2) continue;

                    const type = val[0]; // '+' Êàñ '*'
                    const num = parseFloat(val.slice(1));

                    if (isNaN(num)) continue;

                    if (type === '+') {
                        // Á¥ØÂä†Êï∏ÂÄºÔºàÁõ¥Êé•Â¢ûÂä†Ôºâ
                        player.talentEffect[key] = (player.talentEffect[key] || 0) + num;
                    } else if (type === '*') {
                        // ‰πòÊ≥ïÔºàËΩâÊèõÊàêÁôæÂàÜÊØîÔºå‰æãÂ¶Ç *1.2 ‚Üí +20Ôºâ
                        player.talentEffect[key] = (player.talentEffect[key] || 0) + ((num - 1) * 100);
                    }
                }
            });
        }


        function calculateStats(player) {
            // === ÂÖàÂ•óÁî®Â§©Ë≥¶ÊïàÊûú ===
            applyTalentEffects();

            // === Âü∫Á§éÂÄº ===
            const atkBase = player.atk + (player.equipment.weapon?.atk || 0);
            const defBase = player.def + (player.equipment.armor?.def || 0);
            const hpBase = player.maxHP + (player.equipment.armor?.hp || 0);
            const mpBase = player.maxMP + (player.equipment.weapon?.mp || 0);

            // === Â•óÁî®Â§©Ë≥¶Âä†ÊàêÔºàÁµêÁÆóÂçÄÔºâ===
            const stats = {
                atk: Math.round((atkBase + (player.statBonus.atk || 0)) * (1 + (player.talentEffect.atkPercent || 0) / 100)),
                def: Math.round((defBase + (player.statBonus.def || 0)) * (1 + (player.talentEffect.defPercent || 0) / 100)),
                maxHP: Math.round((hpBase + (player.statBonus.hp || 0)) + (player.talentEffect.maxHP || 0)),
                maxMP: Math.round((mpBase + (player.statBonus.mp || 0))),
                expRate: 1 + (player.talentEffect.expRate || 0) / 100,
                coinRate: 1 + (player.talentEffect.coinBonus || 0) / 100,
                trainRate: 1 + (player.talentEffect.trainBoost || 0) / 100,
                dropRate: 0.5 + (player.talentEffect.dropRate || 0) / 100
            };


            return stats;
        }


        function updateBars() {
            stats = calculateStats(player);

            hp_bar.style.width = (player.currentHP / stats.maxHP * 100) + "%";
            hp_text.innerText = player.currentHP + "/" + stats.maxHP;

            mage_bar.style.width = (player.currentMP / stats.maxMP * 100) + "%";
            mage_text.innerText = player.currentMP + "/" + stats.maxMP;

            exp_bar.style.width = (player.exp / player.maxExp) * 100 + "%";
            exp_text.innerText = player.exp + "/" + player.maxExp;

            document.getElementById('lvl').innerText = player.lvl;
            document.getElementById('atk').innerText = stats.atk;
            document.getElementById('def').innerText = stats.def;
            document.getElementById('coin').innerText = player.coin;
            refreshStatPanel();
        }
        stats = calculateStats(player);

        // üèô ÂüéÂ∏ÇÊäÄËÉΩÁÆ°ÁêÜÔºà‰ΩøÁî® equipSkillsÔºâ
        function openCitySkill() {
            const overlay = document.getElementById('citySkillOverlay');
            const cityList = document.getElementById('citySkillList');
            const equipList = document.getElementById('battleSkillList');
            cityList.innerHTML = '';
            equipList.innerHTML = '';

            // ÂàùÂßãÂåñ
            if (!player.equipSkills) player.equipSkills = [];

            // -----------------------------
            // üß© Â∑¶ÂÅ¥ ‚Äî ÁõÆÂâçË£ùÂÇôÁöÑÊäÄËÉΩ
            // -----------------------------
            if (player.equipSkills.length === 0) {
                equipList.innerHTML = '<p style="color:#aaa;">Â∞öÊú™Ë£ùÂÇô‰ªª‰ΩïÊäÄËÉΩ„ÄÇ</p>';
            } else {
                player.equipSkills.forEach((skillName, index) => {
                    const data = skillDatabase[skillName];
                    if (!data) return;

                    const div = document.createElement('div');
                    div.setAttribute('style', `
                border-bottom:1px solid #555;
                padding:6px; margin-bottom:4px;
                display:flex; flex-direction:column;
            `);
                    div.innerHTML = `
                <b>${skillName}</b><br>
                <small>${data.desc}</small>
            `;

                    // ÊåâÈàïÁæ§ÁµÑ
                    const btnGroup = document.createElement('div');
                    btnGroup.setAttribute('style', 'margin-top:5px; display:flex; gap:5px;');

                    const upBtn = document.createElement('button');
                    upBtn.innerText = '‚¨ÜÔ∏è';
                    upBtn.setAttribute('style', `
                padding:2px 6px; border:none; border-radius:4px;
                background:#777; color:white; cursor:pointer;
            `);
                    upBtn.onclick = () => moveEquipSkill(index, -1);

                    const downBtn = document.createElement('button');
                    downBtn.innerText = '‚¨áÔ∏è';
                    downBtn.setAttribute('style', `
                padding:2px 6px; border:none; border-radius:4px;
                background:#777; color:white; cursor:pointer;
            `);
                    downBtn.onclick = () => moveEquipSkill(index, 1);

                    const removeBtn = document.createElement('button');
                    removeBtn.innerText = '‚ùå Âç∏‰∏ã';
                    removeBtn.setAttribute('style', `
                padding:4px 8px; border:none; border-radius:4px;
                background:#a33; color:white; cursor:pointer;
            `);
                    removeBtn.onclick = () => unequipSkill(skillName);

                    btnGroup.appendChild(upBtn);
                    btnGroup.appendChild(downBtn);
                    btnGroup.appendChild(removeBtn);
                    div.appendChild(btnGroup);
                    equipList.appendChild(div);
                });
            }

            // -----------------------------
            // üß© Âè≥ÂÅ¥ ‚Äî Â∑≤Â≠∏ÊäÄËÉΩÔºàÂèØË£ùÂÇôÔºâ
            // -----------------------------
            if (!player.skills || player.skills.length === 0) {
                cityList.innerHTML = '<p>Â∞öÊú™Â≠∏ÊúÉ‰ªª‰ΩïÊäÄËÉΩ„ÄÇ</p>';
            } else {
                player.skills.forEach(skill => {
                    const data = skillDatabase[skill.name];
                    const div = document.createElement('div');
                    div.setAttribute('style', `
                border-bottom:1px solid #555;
                padding:6px; margin-bottom:4px;
            `);

                    const isEquipped = player.equipSkills.includes(skill.name);
                    div.innerHTML = `
                <b>${skill.name}</b> (Lv.${skill.lvl || 1})<br>
                <small>${data.desc}</small><br>
                MPÊ∂àËÄóÔºö${data.mpCost}
            `;

                    const btn = document.createElement('button');
                    btn.innerText = isEquipped ? 'üü¢ Â∑≤Ë£ùÂÇô' : '‚öîÔ∏è Ë£ùÂÇôÊäÄËÉΩ';
                    btn.disabled = isEquipped;
                    btn.setAttribute('style', `
                margin-top:5px; padding:4px 8px;
                ${isEquipped
                            ? 'background:#2a2a2a; color:#aaa; cursor:default; border:1px solid #666;'
                            : 'background:#007bff; color:white; cursor:pointer; border:none;'}
                border-radius:4px;
            `);
                    if (!isEquipped) btn.onclick = () => equipSkill(skill.name);

                    div.appendChild(btn);
                    cityList.appendChild(div);
                });
            }

            overlay.style.display = 'block';
            loadBattleSkillBar()
        }

        // üß© ÈóúÈñâ‰ªãÈù¢
        function closeCitySkill() {
            document.getElementById('citySkillOverlay').style.display = 'none';
        }

        // ‚öîÔ∏è Ë£ùÂÇôÊäÄËÉΩ
        function equipSkill(skillName) {
            if (!player.equipSkills) player.equipSkills = [];
            if (player.equipSkills.includes(skillName))
                return notify(`‚ö†Ô∏è ${skillName} Â∑≤Á∂ìË£ùÂÇô`, "#fff8d6");

            // ÈôêÂà∂Ë£ùÂÇôÊï∏ÈáèÔºà‰æãÂ¶ÇÊúÄÂ§ö4ÂÄãÔºâ
            if (player.equipSkills.length >= 4)
                return notify(`‚ö†Ô∏è ‰Ω†ÊúÄÂ§öÂè™ËÉΩË£ùÂÇô4ÂÄãÊäÄËÉΩ`, "#ffd1d1");

            player.equipSkills.push(skillName);
            notify(`‚úÖ Â∑≤Ë£ùÂÇô ${skillName}`, "#d1ffd1");
            savePlayer();
            openCitySkill();
        }

        // ‚ùå Âç∏‰∏ãÊäÄËÉΩ
        function unequipSkill(skillName) {
            player.equipSkills = player.equipSkills.filter(s => s !== skillName);
            notify(`‚ùå Â∑≤Âç∏‰∏ã ${skillName}`, "#ffd1d1");
            savePlayer();
            openCitySkill();
        }

        // ‚ÜïÔ∏è ÁßªÂãïÊäÄËÉΩÈ†ÜÂ∫è
        function moveEquipSkill(index, direction) {
            const arr = player.equipSkills;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= arr.length) return;
            const temp = arr[index];
            arr[index] = arr[newIndex];
            arr[newIndex] = temp;
            notify(`‚ÜïÔ∏è Â∑≤Ë™øÊï¥ÊäÄËÉΩÈ†ÜÂ∫è`, "#fff8d6");
            savePlayer();
            openCitySkill();
        }

        // ‚öîÔ∏è Êà∞È¨•ÊäÄËÉΩÂàóÔºàÈ°ØÁ§∫ equipSkillsÔºâ
        function loadBattleSkillBar() {
            const bar = document.getElementById('battleSkillBar');
            bar.innerHTML = '';

            // üß© Ê™¢Êü•ÊòØÂê¶Â≠òÂú®ÊäÄËÉΩÊ¨Ñ
            if (!player.equipSkills || player.equipSkills.length === 0) {
                bar.style.display = 'flex'; // ‰øùÁïôÂ§ñËßÄ
                bar.innerHTML = `<span style="color:#888;">ÁõÆÂâçÊ≤íÊúâË£ùÂÇô‰ªª‰ΩïÊäÄËÉΩ</span>`;
                return;
            }

            // üß© ÁîüÊàêÊäÄËÉΩÊåâÈàï
            player.equipSkills.forEach(skillName => {
                const btn = document.createElement('button');
                btn.innerText = skillName;
                btn.setAttribute('style', `
            padding:8px 12px;
            font-size:14px;
            border:none;
            border-radius:6px;
            background:#444;
            color:white;
            cursor:pointer;
            transition:background 0.2s;
        `);
                btn.onclick = () => useSkill(skillName);
                btn.onmouseenter = () => btn.style.background = '#666';
                btn.onmouseleave = () => btn.style.background = '#444';
                bar.appendChild(btn);
            });

            bar.style.display = 'flex';
        }


        // Èö±ËóèÊà∞È¨•ÊäÄËÉΩÂàó
        function hideBattleSkillBar() {
            document.getElementById('battleSkillBar').style.display = 'none';
        }




        function useSkill(name) {
            const skill = skillDatabase[name];
            if (!skill) return notify("Êú™Áü•ÊäÄËÉΩ", "#ffd1d1");

            if (player.currentMP < skill.mpCost) {
                notify("‚ùå MP ‰∏çË∂≥ÔºåÁÑ°Ê≥ïÊñΩÊîæÊäÄËÉΩÔºÅ", "#ffd1d1");
                return;
            }

            const stats = calculateStats(player);
            const enemy = window.currentEnemy;
            if (!enemy) {
                notify("Ê≤íÊúâÊïµ‰∫∫ÂèØ‰ª•ÊñΩÊîæÊäÄËÉΩ„ÄÇ", "#ffd1d1");
                return;
            }

            // Ê∂àËÄó MP
            player.useMP(skill.mpCost);
            updateBars();

            // ÂÅúÊ≠¢ÈÄ£Á∫åÊà∞È¨•ÔºåÈÅøÂÖçÈáçË§áËß∏Áôº
            setBattleButtonsDisabled(true);

            // üî• Ê†πÊìöÊäÄËÉΩÈ°ûÂûãËôïÁêÜÊïàÊûú
            switch (skill.type) {
                /** üî• ÊîªÊìäÈ°ûÊäÄËÉΩ **/
                case "attack": {
                    const dmg = Math.round(stats.atk * 1.0 + skill.power); // ÊîªÊìäÂäõ100% + ÊäÄËÉΩÂÇ∑ÂÆ≥
                    notify(`üî• ÊñΩÊîæ ${name}ÔºÅÈÄ†Êàê ${dmg} ÈªûÁÅ´ÁÑ∞ÂÇ∑ÂÆ≥ÔºÅ`, "#fff8d6");

                    animateAttack("player", () => {
                        enemy.hp -= dmg;
                        showDamageNumber("enemy", dmg);

                        if (enemy.hp <= 0) {
                            showBattleResult(enemy);
                        } else {
                            // Êïµ‰∫∫ÂèçÊìä
                            animateAttack("enemy", () => {
                                const enemyDmg = Math.max(enemy.atk - stats.def, 1);
                                player.takeDamage(enemyDmg);
                                showDamageNumber("player", enemyDmg);

                                if (player.currentHP <= 0) {
                                    showPlayerDeath(enemy);
                                } else {
                                    updateBars();
                                    setBattleButtonsDisabled(false);
                                }
                            });
                        }
                    });
                    break;
                }

                /** üíö Ê≤ªÁôíË°ì **/
                case "heal": {
                    const healAmt = Math.round(stats.maxHP * 0.1 + skill.power);
                    player.heal(healAmt);
                    notify(`ÊñΩÊîæ ${name}ÔºåÊÅ¢Âæ© ${healAmt} HPÔºÅ`, "#d1ffd1");
                    updateBars();
                    setBattleButtonsDisabled(false);
                    break;
                }

                /** üí™ Âº∑Âåñ Buff **/
                case "buff": {
                    const originalAtk = stats.atk;
                    const buffValue = Math.round(player.atk * 0.2);
                    player.atk += buffValue;

                    notify(`‰ΩøÁî® ${name}ÔºåÊîªÊìäÂäõÊèêÂçá 20%ÔºàÊåÅÁ∫å 3 ÂõûÂêàÔºâ`, "#fff8d6");

                    // 3 ÂõûÂêàÂæåÊÅ¢Âæ©
                    setTimeout(() => {
                        player.atk = originalAtk;
                        notify("Âº∑ÂåñÊïàÊûúÁµêÊùü„ÄÇ", "#f5f5dc");
                        savePlayer();
                    }, 3000 * 3); // Ê®°Êì¨3ÂõûÂêàÊïàÊûú

                    savePlayer();
                    updateBars();
                    setBattleButtonsDisabled(false);
                    break;
                }

                /** üíÄ Âº±Âåñ Debuff **/
                case "debuff": {
                    if (!enemy) return;
                    const debuffValue = Math.round(enemy.atk * 0.2);
                    enemy.atk -= debuffValue;
                    notify(`üåÄ ${name}ÔºÅÊïµ‰∫∫ÊîªÊìäÂäõÈôç‰Ωé 20%ÔºàÊåÅÁ∫å 3 ÂõûÂêàÔºâ`, "#fff8d6");

                    // 3 ÂõûÂêàÂæåÊÅ¢Âæ©
                    setTimeout(() => {
                        enemy.atk += debuffValue;
                        notify(`üí´ ${enemy.name} ÁöÑÊîªÊìäÊÅ¢Âæ©Ê≠£Â∏∏„ÄÇ`, "#fff8d6");
                    }, 3000 * 3);

                    updateBars();
                    setBattleButtonsDisabled(false);
                    break;
                }

                /** ‚ùÑÔ∏è ÊéßÂ†¥ÊäÄËÉΩÔºöÂÜ∞ÂáçË°ì **/
                case "control": {
                    const dmg = Math.round(stats.atk * 1.0 + skill.power);
                    notify(`‰ΩøÁî® ${name}ÔºÅÈÄ†Êàê ${dmg} ÈªûÂÜ∞ÂáçÂÇ∑ÂÆ≥ÔºåÊïµ‰∫∫Ë¢´ÂÜ∞Âáç 1 ÂõûÂêàÔºÅ`, "#fff8d6");

                    animateAttack("player", () => {
                        enemy.hp -= dmg;
                        showDamageNumber("enemy", dmg);

                        if (enemy.hp <= 0) {
                            showBattleResult(enemy);
                            return;
                        }

                        // Ë®≠ÁΩÆÂÜ∞ÂáçÁãÄÊÖã
                        enemy.isFrozen = true;
                        savePlayer();

                        setTimeout(() => {
                            enemy.isFrozen = false;
                            notify(`üßä ${enemy.name} Ëß£Âáç‰∫ÜÔºÅ`, "#fff8d6");
                        }, 3000);

                        updateBars();
                        setBattleButtonsDisabled(false);
                    });
                    break;
                }

                /** ÂÖ∂‰ªñÊäÄËÉΩ **/
                default:
                    notify(`ÊäÄËÉΩ ${name} ÈÇÑÊ≤íÊúâÂØ¶‰ΩúÊïàÊûú`, "#ffd1d1");
                    setBattleButtonsDisabled(false);
                    break;
            }

            savePlayer();
        }

        function closeSkill() {
            document.getElementById('skillOverlay').style.display = 'none';
        }


        function openStatPanel() {
            const iframe = document.getElementById('gameFrame');
            const stats = calculateStats(player); // ‚úÖ ÂèñÂæóÂä†ÊàêÂæåÁöÑÊúÄÁµÇÂ±¨ÊÄß

            iframe.srcdoc = `
    <html>
      <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
      </head>
      <body style="font-family:sans-serif; text-align:center; background:#f5f5dc; min-height:100vh;">
        <div class="container py-4">
          <h1 class="mb-4">‰∫∫Áâ©Âä†Èªû</h1>
          <p>Á≠âÁ¥öÔºö${player.lvl}</p>
          <p>ÂèØÁî®Â±¨ÊÄßÈªûÔºö<strong id="points">${player.statPoints}</strong></p>

          <table class="table table-bordered w-50 mx-auto">
            <tr><th>Â±¨ÊÄß</th><th>Áï∂ÂâçÂÄºÔºàÂê´Âä†ÊàêÔºâ</th><th>Êìç‰Ωú</th></tr>
            <tr>
              <td>ÊîªÊìäÂäõ</td>
              <td id="atkVal">${stats.atk}</td>
              <td><button class="btn btn-sm btn-success" onclick="parent.addStat('atk')">+1</button></td>
            </tr>
            <tr>
              <td>Èò≤Á¶¶Âäõ</td>
              <td id="defVal">${stats.def}</td>
              <td><button class="btn btn-sm btn-success" onclick="parent.addStat('def')">+1</button></td>
            </tr>
            <tr>
              <td>ÊúÄÂ§ßÁîüÂëΩ</td>
              <td id="hpVal">${stats.maxHP}</td>
              <td><button class="btn btn-sm btn-success" onclick="parent.addStat('hp')">+10</button></td>
            </tr>
            <tr>
              <td>ÊúÄÂ§ßÈ≠îÂäõ</td>
              <td id="mpVal">${stats.maxMP}</td>
              <td><button class="btn btn-sm btn-success" onclick="parent.addStat('mp')">+10</button></td>
            </tr>
          </table>

          <button class="btn btn-warning mt-3 me-3" onclick="parent.resetStats()">ÈáçÁΩÆÂ±¨ÊÄßÈªû</button>
          <button class="btn btn-primary mt-4" onclick="parent.loadTown()">ËøîÂõûÂüéÈéÆ</button>
        </div>
      </body>
    </html>`;
        }


        function addStat(type) {
            if (player.statPoints <= 0) {
                notify("‚ùå Ê≤íÊúâÂèØÂàÜÈÖçÁöÑÂ±¨ÊÄßÈªûÔºÅ", "#ffd1d1");
                return;
            }

            switch (type) {
                case "atk":
                    player.statBonus.atk += 1;
                    break;
                case "def":
                    player.statBonus.def += 1;
                    break;
                case "hp":
                    player.statBonus.hp += 10; // ÊØèÈªûÂä†10HP
                    break;
                case "mp":
                    player.statBonus.mp += 10; // ÊØèÈªûÂä†10MP
                    break;
            }

            player.statPoints -= 1;
            savePlayer();
            updateBars();
            refreshStatPanel();
            notify(`Â∑≤Âä†Èªû ${type.toUpperCase()}ÔºÅÂâ©È§òÈªûÊï∏Ôºö${player.statPoints}`, "#d1ffd1");
        }
        function resetStats() {
            if (!confirm("ÊòØÂê¶Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÂ±¨ÊÄßÈªûÔºü")) return;

            // üßÆ Áµ±Ë®àÈÄÄÈÇÑÁöÑÈªûÊï∏
            const totalReturned =
                player.statBonus.atk +
                player.statBonus.def +
                player.statBonus.hp / 10 +
                player.statBonus.mp / 10;

            // Ê∏ÖÁ©∫Âä†Êàê
            player.statBonus = { atk: 0, def: 0, hp: 0, mp: 0 };
            player.statPoints += totalReturned;

            savePlayer();
            updateBars();
            refreshStatPanel();
            notify(` Â∑≤ÈáçÁΩÆÊâÄÊúâÂ±¨ÊÄßÈªûÔºÅËøîÈÇÑ ${totalReturned} Èªû`, "#fff8d6");
        }


        function refreshStatPanel() {
            const iframe = document.getElementById('gameFrame');
            const doc = iframe?.contentDocument || iframe?.contentWindow?.document;
            if (!doc) return;

            // Âè™Âú®„Äå‰∫∫Áâ©Âä†Èªû„ÄçÁï´Èù¢ÊôÇÊõ¥Êñ∞
            const title = doc.querySelector("h1")?.innerText || "";
            if (!title.includes("‰∫∫Áâ©Âä†Èªû")) return;

            // ‚úÖ ÈáçÊñ∞Ë®àÁÆóÊúÄÁµÇÂ±¨ÊÄßÂÄº
            const stats = calculateStats(player);

            // Êõ¥Êñ∞ÊâÄÊúâÊ¨Ñ‰Ωç
            if (doc.getElementById('points')) doc.getElementById('points').textContent = player.statPoints;
            if (doc.getElementById('atkVal')) doc.getElementById('atkVal').textContent = stats.atk;
            if (doc.getElementById('defVal')) doc.getElementById('defVal').textContent = stats.def;
            if (doc.getElementById('hpVal')) doc.getElementById('hpVal').textContent = stats.maxHP;
            if (doc.getElementById('mpVal')) doc.getElementById('mpVal').textContent = stats.maxMP;

            // Êõ¥Êñ∞Á≠âÁ¥öÊñáÂ≠ó
            const lvlP = Array.from(doc.querySelectorAll("p")).find(p => p.innerText.includes("Á≠âÁ¥ö"));
            if (lvlP) lvlP.innerText = `Á≠âÁ¥öÔºö${player.lvl}`;
        }



        function restAtInn() {
            player.currentHP = player.maxHP;
            player.currentMP = player.maxMP;
            updateBars();
            notify("‰Ω†Âú®ÊóÖÈ§®‰ºëÊÅØ‰∫Ü‰∏ÄÊôöÔºåÈ´îÂäõÂíåÈ≠îÂäõÈÉΩÊÅ¢Âæ©‰∫ÜÔºÅ", "#fff8d6");
            setTimeout(() => loadTown(), 300);
        }



        function loadInventory() {
            const overlay = document.getElementById('inventoryOverlay');
            const tooltip = document.getElementById('tooltip');

            // ---- Ë£ùÂÇôÊ¨Ñ ----
            const weaponSlot = document.getElementById('weaponSlot');
            weaponSlot.innerHTML = `<strong>Ê≠¶Âô®:</strong> `;
            if (player.equipment.weapon) {
                weaponSlot.innerHTML += player.equipment.weapon.name;
                const btn = document.createElement('button');
                btn.innerText = 'Âç∏‰∏ã';
                btn.className = 'btn btn-sm btn-warning';
                btn.onclick = () => { player.unequip('weapon'); updateBars(); loadInventory(); };
                weaponSlot.appendChild(btn);
            } else weaponSlot.innerHTML += 'ÁÑ°';

            const armorSlot = document.getElementById('armorSlot');
            armorSlot.innerHTML = `<strong>Èò≤ÂÖ∑:</strong> `;
            if (player.equipment.armor) {
                armorSlot.innerHTML += player.equipment.armor.name;
                const btn = document.createElement('button');
                btn.innerText = 'Âç∏‰∏ã';
                btn.className = 'btn btn-sm btn-warning';
                btn.onclick = () => { player.unequip('armor'); updateBars(); loadInventory(); };
                armorSlot.appendChild(btn);
            } else armorSlot.innerHTML += 'ÁÑ°';

            // ---- Áâ©ÂìÅÊ¨Ñ ----
            const table = document.getElementById('inventoryTable');
            table.innerHTML = `
        <tr>
            <th style="border-bottom:1px solid #000; text-align:left; padding:4px;">Áâ©ÂìÅ</th>
            <th style="border-bottom:1px solid #000; text-align:left; padding:4px;">Êï∏Èáè</th>
        </tr>
    `;

            player.inventory.forEach(item => {
                // ‚úÖ ÊîØÊè¥ÊäÄËÉΩÊõ∏ÔºöÂ¶ÇÊûú itemDatabase Êâæ‰∏çÂà∞ÔºåÂÜçÂæû skillDatabase ÁîüÊàêÊö´ÊôÇË≥áÊñô
                let base = itemDatabase[item.name];
                if (!base && item.type === "skillBook") {
                    const skill = skillDatabase[item.skillRef] || skillDatabase[item.name.replace("Êõ∏", "")];
                    if (skill) {
                        base = {
                            name: item.name,
                            type: "skillBook",
                            price: skill.price || item.price,
                            content: `ÂèØÂ≠∏ÊúÉÊäÄËÉΩÔºö${item.skillRef || item.name.replace("Êõ∏", "")}\n${skill.desc}`
                        };
                    }
                }

                // Ëã•‰ªçÊâæ‰∏çÂà∞ÂâáË∑≥ÈÅé
                if (!base) return;

                const row = table.insertRow();
                row.insertCell().innerText = base.name;
                row.insertCell().innerText = item.quantity;

                // Tooltip È°ØÁ§∫
                row.onmouseenter = e => {
                    tooltip.innerText = `${base.name}
È°ûÂûã: ${base.type === "skillBook" ? "ÊäÄËÉΩÊõ∏" : base.type}
Ë™™Êòé: ${base.content || 'ÁÑ°'}`;
                    tooltip.style.left = e.pageX + 15 + 'px';
                    tooltip.style.top = e.pageY + 15 + 'px';
                    tooltip.style.display = 'block';
                };
                row.onmousemove = e => {
                    tooltip.style.left = e.pageX + 15 + 'px';
                    tooltip.style.top = e.pageY + 15 + 'px';
                };
                row.onmouseleave = () => { tooltip.style.display = 'none'; };

                // ÈªûÊìäÈ°ØÁ§∫Êìç‰ΩúÊåâÈàï
                row.onclick = () => {
                    const existing = table.querySelector('.action-row');
                    if (existing) existing.remove();

                    const actionRow = table.insertRow(row.rowIndex + 1);
                    actionRow.className = 'action-row';
                    const cell = actionRow.insertCell();
                    cell.colSpan = 2;
                    cell.style.textAlign = 'center';

                    // üß™ Ê∂àËÄóÂìÅ
                    if (base.type === 'consumable') {
                        const useBtn = document.createElement('button');
                        useBtn.innerText = '‰ΩøÁî®';
                        useBtn.className = 'btn btn-sm btn-primary me-2';
                        useBtn.onclick = () => { player.useItem(base.name); updateBars(); loadInventory(); };
                        cell.appendChild(useBtn);

                        const removeBtn = document.createElement('button');
                        removeBtn.innerText = '‰∏üÊ£Ñ';
                        removeBtn.className = 'btn btn-sm btn-danger';
                        removeBtn.onclick = () => { if (confirm(`‰∏üÊ£Ñ ${base.name}?`)) { player.removeItem(base.name); loadInventory(); } };
                        cell.appendChild(removeBtn);
                    }

                    // ‚öôÔ∏è Ë£ùÂÇô
                    if (base.type === 'weapon' || base.type === 'armor') {
                        const isEquipped = (base.type === 'weapon' && player.equipment.weapon?.name === base.name)
                            || (base.type === 'armor' && player.equipment.armor?.name === base.name);
                        const equipBtn = document.createElement('button');
                        equipBtn.innerText = isEquipped ? 'Âç∏‰∏ã' : 'Ë£ùÂÇô';
                        equipBtn.className = `btn btn-sm ${isEquipped ? 'btn-warning' : 'btn-success'} me-2`;
                        equipBtn.onclick = () => {
                            if (isEquipped) player.unequip(base.type);
                            else player.equip(base.name);
                            updateBars();
                            loadInventory();
                        };
                        cell.appendChild(equipBtn);

                        if (!isEquipped) {
                            const removeBtn = document.createElement('button');
                            removeBtn.innerText = '‰∏üÊ£Ñ';
                            removeBtn.className = 'btn btn-sm btn-danger';
                            removeBtn.onclick = () => {
                                if (confirm(`‰∏üÊ£Ñ ${base.name}?`)) {
                                    player.removeItem(base.name);
                                    loadInventory();
                                }
                            };
                            cell.appendChild(removeBtn);
                        }
                    }

                    // üìò ÊäÄËÉΩÊõ∏Êìç‰Ωú
                    if (item.type === 'skillBook') {
                        const learnBtn = document.createElement('button');
                        learnBtn.innerText = 'Â≠∏ÁøíÊäÄËÉΩ';
                        learnBtn.className = 'btn btn-sm btn-primary me-2';
                        learnBtn.onclick = () => {
                            player.useItem(item.name);
                            updateBars();
                            loadInventory();
                        };
                        cell.appendChild(learnBtn);

                        const removeBtn = document.createElement('button');
                        removeBtn.innerText = '‰∏üÊ£Ñ';
                        removeBtn.className = 'btn btn-sm btn-danger';
                        removeBtn.onclick = () => {
                            if (confirm(`‰∏üÊ£Ñ ${item.name}?`)) {
                                player.removeItem(item.name);
                                loadInventory();
                            }
                        };
                        cell.appendChild(removeBtn);
                    }
                };
            });

            overlay.style.display = 'flex';
        }






        function closeInventory() {
            document.getElementById('inventoryOverlay').style.display = 'none';
        }


        function updateInventoryTable() {
            const iframe = document.getElementById('gameFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            const table = doc.getElementById('inventory');

            table.innerHTML = '<tr><th>Áâ©ÂìÅ</th><th>Êï∏Èáè</th><th>Êìç‰Ωú</th></tr>';

            player.inventory.forEach((item, i) => {
                const row = table.insertRow();
                row.insertCell().innerText = item.name;
                row.insertCell().innerText = item.quantity;

                const actionCell = row.insertCell();
                const useBtn = doc.createElement('button');
                useBtn.classList.add('btn', 'btn-sm', 'btn-success', 'me-2');
                useBtn.innerText = '‰ΩøÁî®';
                useBtn.onclick = () => {
                    player.useItem(item.name);
                    updateInventoryTable();
                };

                const removeBtn = doc.createElement('button');
                removeBtn.classList.add('btn', 'btn-sm', 'btn-danger');
                removeBtn.innerText = '‰∏üÊ£Ñ';
                removeBtn.onclick = () => {
                    player.removeItem(item.name);
                    updateInventoryTable();
                };

                actionCell.appendChild(useBtn);
                actionCell.appendChild(removeBtn);
            });
        }



        function updateTaskTable(doc) {
            const table = doc.getElementById('task');
            if (!table) return console.error("Êâæ‰∏çÂà∞ task table");

            // Âª∫Á´ã tbodyÔºåÂ¶ÇÊûúÊ≤íÊúâÁöÑË©±
            let tbody = table.querySelector('tbody');
            if (!tbody) {
                tbody = doc.createElement('tbody');
                table.appendChild(tbody);
            }

            tbody.innerHTML = ''; // Ê∏ÖÁ©∫ÂéüÊúâ‰ªªÂãôÂàó

            tasks.forEach((task) => {
                const row = tbody.insertRow();

                // ÊâæÁé©ÂÆ∂‰ªªÂãô
                const playerTask = player.tasks.find(t => t.name === task.name);

                // ‰ªªÂãôÂêçÁ®± + ÈÄ≤Â∫¶
                let taskText = task.name + ` *${task.count}`;
                if (playerTask) {
                    taskText += ` (${playerTask.progress}/${task.count})`;
                }

                const nameCell = row.insertCell();
                nameCell.innerText = taskText;
                nameCell.style.wordBreak = 'break-word'; // Ëá™ÂãïÊèõË°å
                nameCell.style.maxWidth = '200px'; // ÈôêÂà∂ÂØ¨Â∫¶ÔºåÈÅøÂÖçÊì†Âà∞Âè≥ÈÇä
                nameCell.style.verticalAlign = 'middle';

                // ÁçéÂãµÊ¨Ñ
                const rewardText = `Èå¢:${task.rewards.coin || 0} | Á∂ìÈ©ó:${task.rewards.exp || 0} | Áâ©ÂìÅ:${task.rewards.items?.join(', ') || 'ÁÑ°'}`;
                const rewardCell = row.insertCell();
                rewardCell.innerText = rewardText;
                rewardCell.style.wordBreak = 'break-word';
                rewardCell.style.verticalAlign = 'middle';

                // ÊåâÈàïÊ¨Ñ
                const actionCell = row.insertCell();
                actionCell.style.verticalAlign = 'middle';

                const btn = doc.createElement('button');
                btn.classList.add('btn', 'btn-sm', 'w-100'); // ÂØ¨Â∫¶ 100%
                btn.style.margin = '2px 0';
                btn.style.whiteSpace = 'nowrap'; // ‰∏çÊèõË°å

                if (!playerTask) {
                    // Êú™Êé•‰ªªÂãô
                    btn.innerText = 'Êé•Âèñ‰ªªÂãô';
                    btn.classList.add('btn-success');
                    btn.onclick = () => {
                        player.tasks.push({
                            name: task.name,
                            rewards: task.rewards,
                            status: 'ÈÄ≤Ë°å‰∏≠',
                            progress: 0
                        });
                        updateTaskTable(doc);
                    };
                } else if (playerTask.progress < task.count) {
                    // ÈÄ≤Ë°å‰∏≠
                    btn.innerText = 'Â∑≤Êé•Âèñ';
                    btn.classList.add('btn-secondary', 'disabled');
                } else {
                    // Â∑≤ÂÆåÊàê
                    btn.innerText = 'ÂÆåÊàê';
                    btn.classList.add('btn-primary');
                    // ÂèØÂú®ÈÄôË£°Âä†È†òÁçéÈÇèËºØ
                    btn.onclick = () => {
                        notify(`È†òÂèñÁçéÂãµ: Èå¢ ${task.rewards.coin}, Á∂ìÈ©ó ${task.rewards.exp}, Áâ©ÂìÅ ${task.rewards.items.join(', ')}`, "#d1ffd1");
                        // ÁúüÊ≠£Áµ¶ÁçéÂãµ
                        player.gainExp(task.rewards.exp);
                        player.coin += Math.round(task.rewards.coin * stats.coinRate);
                        if (task.rewards.items && task.rewards.items.length > 0) {
                            task.rewards.items.forEach(itemName => {
                                player.addItem({ name: itemName });
                            });
                        }
                        // Ê∏ÖÈô§‰ªªÂãôÊàñÈáçÁΩÆÈÄ≤Â∫¶
                        player.tasks = player.tasks.filter(t => t.name !== task.name);
                        savePlayer()
                        updateBars()
                        updateTaskTable(doc);
                    };
                }

                actionCell.appendChild(btn);
            });
        }






        function acceptTask(index, doc) {
            const task = tasks[index];
            if (!player.tasks.some(t => t.name === task.name)) {
                player.tasks.push({ name: task.name, reward: task.reward, status: 'ÈÄ≤Ë°å‰∏≠' });
                updateTaskTable(doc); // ‚úÖ ÂÇ≥ÂÖ• doc
            }
        }

        function completeTask(index, doc) {
            const task = player.tasks[index];
            if (!task) return;

            task.status = 'ÂÆåÊàê';

            updateBars();
            updateTaskTable(doc); // ‚úÖ ÂÇ≥ÂÖ• doc
        }
        // function goToScene(scene) {
        //     const iframe = document.getElementById('gameFrame');
        //     iframe.src = scene + ".html";  // scene ÂèØ‰ª•ÊòØ "town", "battle", "shop"
        // }
        function loadShop() {
            const iframe = document.getElementById('gameFrame');
            let shopHTML = shopItems.map((item, i) =>
                `<tr>
            <td>${item.name}</td>
            <td>üí∞${item.price}</td>
            <td><button class="btn btn-sm btn-success" onclick="parent.buyItem(${i})">Ë≥ºË≤∑</button></td>
        </tr>`
            ).join('');

            iframe.srcdoc = `
    <html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body style="font-family: sans-serif; text-align:center; background:#fff0f5; min-height:100vh;">
        <div class="container ">
            <h1 class="mb-4">üõí ÂïÜÂ∫ó</h1>
            <p>ÈáëÈå¢Ôºö<span id="shopCoin">${player.coin}</span> üí∞</p>
            <table class="table table-bordered table-hover">
                <tr><th>Áâ©ÂìÅ</th><th>ÂÉπÊ†º</th><th>Êìç‰Ωú</th></tr>
                <tbody>${shopHTML}</tbody>
            </table>
            
            <div class="row">
                <div class="col">
                    <button class="btn btn-outline-secondary w-100" onclick="parent.loadInventory()">Áâ©ÂìÅÊ¨Ñ</button>
                </div>
                <div class="col">
                     <button class="btn btn-outline-warning w-100" onclick="parent.loadSell()">Ë≤©Ë≥£Áâ©ÂìÅ</button>
                </div>
                <div class="col">
                    <button class="btn btn-outline-secondary w-100 mb-3" onclick="parent.loadTown()">ËøîÂõûÂüéÈéÆ</button>
                </div>
            </div>
        </div>
    </body>
    </html>
    `;
        }

        function loadSell() {
            const iframe = document.getElementById('gameFrame');
            const sellHTML = player.inventory
                .filter(i => itemDatabase[i.name]?.price)
                .map(item => {
                    const base = itemDatabase[item.name];
                    const sellPrice = Math.floor((base.price || 10) / 2);
                    return `
            <tr>
                <td>${item.name}</td>
                <td>${item.quantity || 1}</td>
                <td>${sellPrice} üí∞</td>
                <td><button class="btn btn-sm btn-danger" onclick="parent.sellItemById('${item.id}')">Ë≤©Ë≥£</button></td>
            </tr>`;
                })
                .join('');

            iframe.srcdoc = `
    <html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body style="font-family: sans-serif; text-align:center; background:#fff8d6;">
        <div class="container">
            <h1 class="mb-4">üí∞ Ë≤©Ë≥£Áâ©ÂìÅ</h1>
            <p>ÁõÆÂâçÈáëÈå¢Ôºö<span id="shopCoin">${player.coin}</span> üí∞</p>
            <table class="table table-bordered table-hover">
                <tr><th>Áâ©ÂìÅ</th><th>Êï∏Èáè</th><th>ÂîÆÂÉπ</th><th>Êìç‰Ωú</th></tr>
                ${sellHTML || '<tr><td colspan="4">ÁõÆÂâçÊ≤íÊúâÂèØË≤©Ë≥£Áâ©ÂìÅ</td></tr>'}
            </table>
            <button class="btn btn-outline-secondary" onclick="parent.loadShop()">ËøîÂõûÂïÜÂ∫ó</button>
        </div>
    </body>
    </html>`;
        }


        function buyItem(index) {
            const item = shopItems[index];
            if (player.coin < item.price) {
                notify("‚ùå ÈáëÈå¢‰∏çË∂≥ÔºÅ", "#ffd1d1");
                return;
            }

            player.coin -= item.price;
            player.addItem({ name: item.name, quantity: 1 });
            savePlayer();
            updateBars();

            notify(`üí∞ Ë≥ºË≤∑ÊàêÂäüÔºö${item.name}`, "#f5f5dc");

            // ‚úÖ Êõ¥Êñ∞Áï´Èù¢ÈáëÈå¢
            const iframe = document.getElementById('gameFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            const coinSpan = doc.getElementById('shopCoin');
            if (coinSpan) coinSpan.textContent = player.coin;
        }


        function sellItemById(id) {
            const index = player.inventory.findIndex(i => i.id === Number(id) || i.id === id);
            if (index === -1) return notify("‚ùå Êâæ‰∏çÂà∞Ë©≤Áâ©ÂìÅ", "#ffd1d1");

            const item = player.inventory[index];
            const base = itemDatabase[item.name];
            const sellPrice = Math.floor((base?.price || item.price || 10) / 2);

            player.inventory.splice(index, 1); // ‚úÖ Âè™Âà™ÊéâË©≤Áâ©‰ª∂
            player.coin += sellPrice;

            savePlayer();
            updateBars();

            const iframe = document.getElementById('gameFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            const coinSpan = doc.getElementById('shopCoin');
            if (coinSpan) coinSpan.textContent = player.coin;

            notify(`üì¶ Ë≥£Âá∫ ${item.name}ÔºåÁç≤Âæó ${sellPrice} ÈáëÂπ£`, "#f5f5dc");

            setTimeout(() => loadSell(), 300);
        }


    </script>

    <!-- <h1>ÂüéÈéÆ</h1>
        <div class="row">
            <div class="col">
                <table id="task"></table>
            </div>
            <div class="col">
                <button class="btn btn-outline-info" onclick="parent.loadScene('shop')">ÈÄ≤ÂÖ•ÂïÜÂ∫ó</button>
                <button class="btn btn-outline-info" onclick="parent.loadScene('ÂõûÁãÄÊÖã')">ÈÄ≤ÂÖ•ÊóÖÈ§®‰ºëÊÅØ(ÂõûÁãÄÊÖã)</button>
            </div>
        </div> -->
    <script>

        function loadTown() {
            const iframe = document.getElementById('gameFrame');
            iframe.srcdoc = `
        <html>
            <head>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            </head>
            <body style="font-family:sans-serif; text-align:center; background:#f5f5dc; min-height:100vh;">
                <div class="container">
                    <h1 class="mb-4">üèôÔ∏è ÂüéÈéÆ</h1>
                    <div class="row justify-content-center">
                        <div class=" col">
                            <table id="task" class="table table-bordered table-hover">
                                <tr><th>‰ªªÂãôÂàóË°®</th><th>ÁçéÂãµ</th><th>Êìç‰Ωú</th></tr>
                            </table>
                        </div>
                        <div class=" col-4">
                            <button class="btn btn-outline-warning w-100 mb-3" onclick="parent.loadBattle()">Êé¢Á¥¢</button>
                            <button class="btn btn-outline-primary w-100 mb-3" onclick="parent.loadShop()">ÈÄ≤ÂÖ•ÂïÜÂ∫ó</button>
                            <button class="btn btn-outline-success w-100 mb-3" onclick="parent.restAtInn()">ÊóÖÈ§®‰ºëÊÅØ</button>
                            <button class="btn btn-outline-secondary w-100 mb-3" onclick="parent.loadInventory()">Áâ©ÂìÅÊ¨Ñ</button>
                            <button class="btn btn-outline-secondary w-100 mb-3" onclick="parent.train()">Ë®ìÁ∑¥</button>
                            <button class="btn btn-outline-secondary w-100 mb-3" onclick="parent.talent()">Â§©Ë≥¶</button>
                            <button class="btn btn-outline-info w-100 mb-3" onclick="parent.openStatPanel()">‰∫∫Áâ©Âä†Èªû</button>
                            <button class="btn btn-outline-danger w-100 mb-3" onclick="parent.openCitySkill()">ÊäÄËÉΩ</button>

                        </div>
                    </div>
                </div>
            </body>
        </html>
    `;

            // ÈÄôË£°ÊòØÂîØ‰∏ÄËß∏ÁôºÊõ¥Êñ∞ table ÁöÑÂú∞Êñπ
            iframe.onload = () => {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                if (!doc) return console.error("iframe content ‰∏çÂ≠òÂú®");

                updateTaskTable(doc); // Â∞á‰ªªÂãôÊ∏≤ÊüìÂà∞ table
            };
        }



        // === ÈÄ≤ÂÖ•Â§©Ë≥¶Áï´Èù¢ ===
        function talent() {
            const iframe = document.getElementById('gameFrame');
            iframe.srcdoc = `
  <html>
    <head>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body style="font-family:sans-serif; text-align:center; background:#fffaf0; min-height:100vh;">
      <div class="container py-5">
        <h1 class="mb-4">üé≤ Â§©Ë≥¶ÊäΩÁçé</h1>
        <p>ÊØèÊ¨°ÊäΩÂèñÈúÄËä±Ë≤ª <strong>500 ÈáëÂπ£</strong></p>
        <button class="btn btn-warning mb-3" onclick="parent.drawTalent()">ÊäΩ‰∏ÄÂÄãÂ§©Ë≥¶ÔºÅ</button>
        <button class="btn btn-outline-secondary mb-4" onclick="parent.loadTown()">ËøîÂõûÂüéÈéÆ</button>
        <hr>
        <h4 class="mt-4">üß† Â∑≤Ë£ùÂÇôÂ§©Ë≥¶ (${player.talentSlots.length}/${getTalentSlotLimit()})</h4>
        <div id="activeTalents" class="mb-4"></div>
      </div>
    </body>
  </html>
  `;
            iframe.onload = () => updateTalentList();
        }

        // === ÊäΩÂ§©Ë≥¶ ===
        function drawTalent() {
            if (player.coin < 500) {
                notify("ÈáëÂπ£‰∏çË∂≥ÔºÅÈúÄË¶Å 500 ÈáëÂπ£„ÄÇ", "#ffd1d1");
                return;
            }

            const available = talents.filter(t => !player.talentSlots.some(s => s.name === t.name));
            if (available.length === 0) {
                notify("‰Ω†Â∑≤Á∂ìÊìÅÊúâÊâÄÊúâÂ§©Ë≥¶‰∫ÜÔºÅ", "#ffd1d1");
                return;
            }

            player.coin -= 500;
            const drawn = available[Math.floor(Math.random() * available.length)];

            showTalentDecision(drawn);
            updateBars();
            savePlayer();
        }

        // === È°ØÁ§∫ÊäΩÂà∞ÁöÑÂ§©Ë≥¶ÈÅ∏Êìá‰ªãÈù¢ ===
        function showTalentDecision(drawn) {
            const iframe = document.getElementById('gameFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            if (!doc) return;

            const container = doc.querySelector('.container');
            if (!container) return;

            container.innerHTML = `
    <h2>üéÅ ‰Ω†ÊäΩÂà∞‰∫ÜÔºö„Äå${drawn.name}„Äç</h2>
    <p class="mb-4">${drawn.desc}</p>
  `;

            const slotLimit = getTalentSlotLimit();

            // Ëã•Ê¨Ñ‰ΩçÊú™Êªø ‚Üí ÂèØÁõ¥Êé•Ë£ùÂÇô
            if (player.talentSlots.length < slotLimit) {
                const equipBtn = doc.createElement('button');
                equipBtn.className = 'btn btn-success me-3';
                equipBtn.innerText = 'Ë£ùÂÇôÊ≠§Â§©Ë≥¶';
                equipBtn.onclick = () => {
                    player.talentSlots.push(drawn);
                    savePlayer();
                    talent();
                    setTimeout(updateTalentList, 50); // ‚úÖ Á≠âÁï´Èù¢ËºâÂÖ•ÂÆåÊàêÂæåÊõ¥Êñ∞
                };
                container.appendChild(equipBtn);
            } else {
                // Ëã•Ê¨Ñ‰ΩçÊªø ‚Üí È°ØÁ§∫ÊõøÊèõÈÅ∏ÂñÆ
                const msg = doc.createElement('p');
                msg.innerText = "‰Ω†ÁöÑÂ§©Ë≥¶Ê¨ÑÂ∑≤ÊªøÔºåË´ãÈÅ∏ÊìáË¶ÅÊõøÊèõÁöÑÂ§©Ë≥¶Ôºö";
                container.appendChild(msg);

                player.talentSlots.forEach((slot, i) => {
                    const btn = doc.createElement('button');
                    btn.className = 'btn btn-outline-danger m-2';
                    btn.innerText = `ÊõøÊèõ„Äå${slot.name}„Äç`;
                    btn.onclick = () => {
                        player.talentSlots[i] = drawn;
                        savePlayer();
                        talent();
                        setTimeout(updateTalentList, 50);
                    };
                    container.appendChild(btn);
                });
            }

            const cancelBtn = doc.createElement('button');
            cancelBtn.className = 'btn btn-secondary m-3';
            cancelBtn.innerText = 'ÊîæÊ£Ñ';
            cancelBtn.onclick = () => talent();
            container.appendChild(cancelBtn);
        }

        // === Êõ¥Êñ∞Â§©Ë≥¶Ê∏ÖÂñÆ ===
        function updateTalentList() {
            const iframe = document.getElementById('gameFrame');
            if (!iframe) return;
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            if (!doc) return;

            const activeDiv = doc.getElementById('activeTalents');
            if (!activeDiv) {
                console.warn("‚ö†Ô∏è Êâæ‰∏çÂà∞ activeTalentsÔºåÂèØËÉΩÁï´Èù¢Â∞öÊú™ËºâÂÖ•");
                return;
            }

            const slotLimit = getTalentSlotLimit();
            activeDiv.innerHTML = '';

            for (let i = 0; i < slotLimit; i++) {
                const slot = doc.createElement('div');
                slot.className = 'border rounded p-2 m-1';
                slot.style.display = 'inline-block';
                slot.style.minWidth = '150px';
                slot.style.background = '#fffbe6';

                if (player.talentSlots[i]) {
                    const t = player.talentSlots[i];
                    slot.innerHTML = `
        <strong>${t.name}</strong><br><span>${t.desc}</span><br>
        <button class="btn btn-sm btn-danger mt-2" onclick="parent.removeTalentSlot(${i})">ÁßªÈô§</button>
      `;
                } else {
                    slot.innerHTML = `<span class="text-muted">ÔºàÁ©∫Ôºâ</span>`;
                }

                activeDiv.appendChild(slot);
            }
        }

        // === ÁßªÈô§Â§©Ë≥¶ ===
        function removeTalentSlot(index) {
            player.talentSlots.splice(index, 1);
            savePlayer();
            setTimeout(updateTalentList, 50);
        }

        // === Ë®ìÁ∑¥ ===
        let trainingInterval = null; // Ë®ìÁ∑¥Ë®àÊôÇÂô®
        let isTraining = false; // ÁãÄÊÖãÊóóÊ®ô

        function train() {
            if (isTraining) {
                stopTraining();
                return;
            }

            if (!isInTown()) {
                notify("‰Ω†Âè™ËÉΩÂú®ÂüéÈéÆ‰∏≠ÈÄ≤Ë°åË®ìÁ∑¥ÔºÅ", "#ffd1d1");
                return;
            }

            isTraining = true;

            trainingInterval = setInterval(() => {
                const stats = calculateStats(player);
                const gain = Math.round(player.train * stats.trainRate); // ‚úÖ Âè™ÂêÉË®ìÁ∑¥Âä†Êàê
                // console.log("Ë®ìÁ∑¥Âä†ÊàêÂÄçÁéá:", stats.trainRate, "gain:", gain);
                player.gainExp(gain);
                savePlayer();
                updateBars();
                updateTrainingStatus(gain);
            }, 1000);

            updateTrainingStatus();
        }

        function stopTraining() {
            if (trainingInterval) {
                clearInterval(trainingInterval);
                trainingInterval = null;
            }
            isTraining = false;
            updateTrainingStatus();
        }

        function updateTrainingStatus(gain = 0) {
            const iframe = document.getElementById('gameFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            if (!doc) return;

            let trainBox = doc.getElementById('trainStatus');

            // === üßπ Â¶ÇÊûúÂÅúÊ≠¢Ë®ìÁ∑¥ÔºåÁõ¥Êé•Âà™Èô§ÊèêÁ§∫Ê°Ü ===
            if (!isTraining) {
                if (trainBox) trainBox.remove();
                return;
            }

            // === Ëã•Ê≤íÊúâÊèêÁ§∫Ê°ÜÂâáÂª∫Á´ã‰∏ÄÂÄã ===
            if (!trainBox) {
                const container = doc.querySelector('.container');
                if (container) {
                    trainBox = doc.createElement('div');
                    trainBox.id = 'trainStatus';
                    trainBox.style.position = 'fixed';
                    trainBox.style.bottom = '10px';
                    trainBox.style.left = '10px'; // ‚úÖ Â∑¶‰∏ãËßí
                    trainBox.style.padding = '8px 12px';
                    trainBox.style.borderRadius = '8px';
                    trainBox.style.background = '#fff8d6';
                    trainBox.style.boxShadow = '0 0 5px rgba(0,0,0,0.2)';
                    trainBox.style.fontSize = '14px';
                    trainBox.style.zIndex = 5000;
                    container.appendChild(trainBox);
                }
            }

            // === Êõ¥Êñ∞Ë®ìÁ∑¥Ë≥áË®äÂÖßÂÆπ ===
            if (trainBox) {
                const stats = calculateStats(player);
                const rate = Math.round((stats.trainRate - 1) * 100);
                const expBonus = Math.round((stats.expRate - 1) * 100);
                trainBox.innerHTML = `
            üí™ Ë®ìÁ∑¥‰∏≠ (+${gain || player.train} EXP/Áßí)
            <br>üìà Ë®ìÁ∑¥Âä†ÊàêÔºö+${rate}%
            <br>üéì Á∂ìÈ©óÂä†ÊàêÔºö+${expBonus}%
            <br>Á≠âÁ¥öÔºö${player.lvl} | Á∂ìÈ©óÔºö${player.exp}/${player.maxExp}
        `;
            }
        }




        // Áï∂ÂàáÊèõÂ†¥ÊôØÔºàÊé¢Á¥¢„ÄÅÂïÜÂ∫ó„ÄÅÊà∞È¨•Á≠âÔºâÊôÇÊö´ÂÅúË®ìÁ∑¥
        function pauseTrainingOnSceneChange() {
            if (isTraining) {
                stopTraining();
                console.log("Ë®ìÁ∑¥Êö´ÂÅúÔºàÂ†¥ÊôØÂàáÊèõÔºâ");
            }
        }
        // Âà§Êñ∑ÁõÆÂâçÊòØÂê¶Âú®ÂüéÈéÆÁï´Èù¢
        function isInTown() {
            const iframe = document.getElementById('gameFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            if (!doc) return false;
            return doc.querySelector('h1')?.innerText.includes('ÂüéÈéÆ') ?? false;
        }


        function animateAttack(attacker, callback) {
            const iframe = document.getElementById('gameFrame');
            if (!iframe) {
                if (typeof callback === 'function') callback();
                return;
            }
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            if (!doc) {
                if (typeof callback === 'function') callback();
                return;
            }

            const actorImg = doc.querySelector(attacker === 'player' ? '.actor.player img' : '.actor.enemy img');
            const targetImg = doc.querySelector(attacker === 'player' ? '.actor.enemy img' : '.actor.player img');

            if (!actorImg || !targetImg) {
                if (typeof callback === 'function') callback();
                return;
            }

            const actorRect = actorImg.getBoundingClientRect();
            const targetRect = targetImg.getBoundingClientRect();
            const distance = attacker === 'player'
                ? targetRect.left - actorRect.right - 10
                : targetRect.right - actorRect.left + 10;

            // ÈáçÁΩÆ transform
            actorImg.style.transition = 'none';
            targetImg.style.transition = 'none';
            actorImg.style.transform = 'translateX(0) rotate(0deg)';
            targetImg.style.transform = 'translateX(0) rotate(0deg)';
            void actorImg.offsetWidth;

            // ÊîªÊìäËÄÖÂâçË°ù
            actorImg.style.transition = 'transform 0.18s ease';
            actorImg.style.transform = `translateX(${distance}px)`;

            setTimeout(() => {
                // ÊîªÊìäËÄÖÊíûÊìäÈúáÂãï + ÊóãËΩâ
                actorImg.animate(
                    [
                        { transform: `translateX(${distance}px) rotate(0deg)` },
                        { transform: `translateX(${distance - 8}px) rotate(90deg)` },
                        { transform: `translateX(${distance + 8}px) rotate(180deg)` },
                        { transform: `translateX(${distance - 8}px) rotate(270deg)` },
                        { transform: `translateX(${distance + 8}px) rotate(360deg)` },
                        { transform: `translateX(${distance}px) rotate(720deg)` }
                    ],
                    { duration: 600, iterations: 1, easing: 'ease-in-out' }
                );

                // ÂèóÊìäËÄÖË¢´ÊíûÊìäÈúáÂãï + ÂæÄÂæåÈÄÄ
                targetImg.animate(
                    [
                        { transform: 'translateX(0)' },
                        { transform: attacker === 'player' ? 'translateX(20px)' : 'translateX(-20px)' },
                        { transform: 'translateX(0)' },
                        { transform: attacker === 'player' ? 'translateX(10px)' : 'translateX(-10px)' },
                        { transform: 'translateX(0)' }
                    ],
                    { duration: 600, iterations: 1, easing: 'ease-in-out' }
                );

                // ÂâçË°ùÁµêÊùüÂæåÈÄÄÂõûÂéü‰Ωç
                setTimeout(() => {
                    actorImg.style.transition = 'transform 0.12s ease';
                    actorImg.style.transform = 'translateX(0) rotate(0deg)';

                    targetImg.style.transition = 'transform 0.12s ease';
                    targetImg.style.transform = 'translateX(0) rotate(0deg)';

                    setTimeout(() => {
                        if (typeof callback === 'function') callback();
                    }, 120);
                }, 600); // Á≠âÂãïÁï´ÁµêÊùüÂÜçÈÄÄÂõû
            }, 180);
        }



        function attackEnemy() {
            if (player.currentHP <= 0) {
                notify('ÊåñÈù†ÔºåÊ≤íË°ÄÈÇÑ‰æÜÊâìÊÄ™ÂñîÔºåÊªæÂõûÂüéÈéÆÂéª', "#ffd1d1");
                setBattleButtonsDisabled(false);
                loadTown()
                return;
            }
            const enemy = window.currentEnemy;
            if (!enemy) return;

            const stats = calculateStats(player);
            setBattleButtonsDisabled(true);
            // ÊîªÊìäÂãïÁï´
            parent.animateAttack('player', () => {
                // ÊíûÊìäÁû¨ÈñìÊâ£Ë°Ä
                const damage = Math.max(stats.atk - enemy.def, 1);
                enemy.hp -= damage;

                // È°ØÁ§∫ÊµÆÂãïÂÇ∑ÂÆ≥ÊñáÂ≠ó
                showDamageNumber('enemy', damage);

                if (enemy.hp <= 0) {
                    checkTasks(enemy);
                    showBattleResult(enemy);
                    setBattleButtonsDisabled(false);
                    return;
                }

                // Êïµ‰∫∫ÂèçÊìäÂãïÁï´
                parent.animateAttack('enemy', () => {
                    const enemyDamage = Math.max(enemy.atk - stats.def, 1);
                    player.currentHP -= enemyDamage;

                    showDamageNumber('player', enemyDamage);
                    if (player.currentHP <= 0) {
                        showPlayerDeath(enemy)

                        setBattleButtonsDisabled(false);
                        return;
                    }
                    savePlayer();
                    setTimeout(() => {
                        loadBattle(false);
                        setBattleButtonsDisabled(false);
                    }, 300);
                });
            });
        }
        function setBattleButtonsDisabled(disabled) {
            const iframe = document.getElementById('gameFrame');
            if (!iframe) return;
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            if (!doc) return;

            const attackBtn = doc.getElementById('btnAttack');
            const runBtn = doc.getElementById('btnRun');

            if (attackBtn) attackBtn.disabled = disabled;
            if (runBtn) runBtn.disabled = disabled;
        }

        function showDamageNumber(target, damage) {
            const iframe = document.getElementById('gameFrame');
            if (!iframe) return;
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            const targetDiv = doc.querySelector(target === 'player' ? '.actor.player' : '.actor.enemy');
            if (!targetDiv) return;

            const dmgEl = doc.createElement('div');
            dmgEl.textContent = `-${damage}`;
            dmgEl.style.position = 'absolute';
            dmgEl.style.color = 'red';
            dmgEl.style.fontWeight = 'bold';
            dmgEl.style.fontSize = '24px';
            dmgEl.style.top = '-30px';
            dmgEl.style.left = '50%';
            dmgEl.style.transform = 'translateX(-50%)';
            dmgEl.style.opacity = 1;
            dmgEl.style.transition = 'transform 0.6s ease, opacity 0.6s ease';

            targetDiv.appendChild(dmgEl);

            // ÊµÆÂãïÊ∂àÂ§±ÂãïÁï´
            setTimeout(() => {
                dmgEl.style.transform = 'translateX(-50%) translateY(-50px)';
                dmgEl.style.opacity = 0;
            }, 50);

            // ÂãïÁï´ÁµêÊùüÂæåÁßªÈô§
            setTimeout(() => {
                dmgEl.remove();
            }, 650);
        }

        function checkTasks(enemy) {
            player.tasks.forEach(task => {
                if (task.status === 'ÈÄ≤Ë°å‰∏≠' && task.name.includes(enemy.name)) {
                    task.progress += 1;
                    const targetTask = tasks.find(t => t.name === task.name);
                    if (!targetTask) return;

                    if (task.progress >= targetTask.count) {
                        task.status = 'ÂÆåÊàê';
                        parent.notify(`‚úÖ ‰ªªÂãôÂÆåÊàêÔºö${task.name}`, "#d1ffd1");
                    } else {
                        parent.notify(`üìà ‰ªªÂãôÈÄ≤Â∫¶Ôºö${task.name} (${task.progress}/${targetTask.count})`, "#fff8d6");
                    }

                    savePlayer();
                }
            });
        }


        function getRandomDrop(enemy, dropRate = 0.5) {
            if (!enemy.drops || enemy.drops.length === 0) return null;

            const rate = Math.min(Math.max(dropRate, 0), 1);
            if (Math.random() >= rate) return null;

            // üéØ ‰∏ÄÂÆöÊ©üÁéáÊéâËêΩÊäÄËÉΩÊõ∏
            const skillDropChance = 0.15; // 15% ÊéâÊäÄËÉΩÊõ∏
            if (Math.random() < skillDropChance) {
                const availableSkills = Object.keys(skillDatabase).filter(
                    s => !player.skills.some(ps => ps.name === s)
                );
                if (availableSkills.length > 0) {
                    const weightedPool = availableSkills.map(name => ({
                        name,
                        weight: skillDatabase[name].rate || 10
                    }));

                    const total = weightedPool.reduce((a, b) => a + b.weight, 0);
                    let roll = Math.random() * total;
                    for (const entry of weightedPool) {
                        roll -= entry.weight;
                        if (roll <= 0) {
                            const skill = skillDatabase[entry.name];
                            // ÊäÄËÉΩÊõ∏‰ΩúÁÇ∫Áâ©ÂìÅÊéâËêΩ
                            const item = {
                                name: entry.name + "Êõ∏",
                                type: "skillBook",
                                price: skill.price,
                                skillRef: entry.name
                            };
                            player.addItem(item);
                            notify(`üìò ÊéâËêΩÊäÄËÉΩÊõ∏Ôºö${entry.name}`, "#d1ffd1");
                            return item;
                        }
                    }
                }
            }

            // üß± ÂéüÊú¨Áâ©ÂìÅÊéâËêΩ
            const weightedPool = enemy.drops.map(name => ({
                name,
                weight: itemDatabase[name]?.rate || 10
            }));

            const totalWeight = weightedPool.reduce((sum, i) => sum + i.weight, 0);
            let roll = Math.random() * totalWeight;
            for (const entry of weightedPool) {
                roll -= entry.weight;
                if (roll <= 0) {
                    const item = { ...itemDatabase[entry.name] };
                    player.addItem(item);
                    return item;
                }
            }

            return null;
        }




        function showPlayerDeath(enemy) {
            const iframe = document.getElementById('gameFrame');

            window.currentEnemy = null;
            player.heal(stats.maxHP)
            savePlayer()
            iframe.srcdoc = `
    <html>
        <head>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        </head>
        <body style="font-family:sans-serif; text-align:center; background:#ffd1d1; min-height:100vh;">
            <div class="container">
                <h1>‰Ω†Ë¢´ ${enemy.name} ÊìäÊïó‰∫ÜÔºÅ </h1>
                <p>ÁúüËèú ÂõûÁ®ãÂüéÈéÆÂú®Á∑¥ÂÄãÂçÅÂπ¥Âêß</p>
                <button class="btn btn-primary" onclick="parent.loadTown()">ËøîÂõûÂüéÈéÆ</button>
            </div>
        </body>
    </html>`;

            updateBars();
        }

        function showBattleResult(enemy) {
            const iframe = document.getElementById('gameFrame');

            // üßÆ ÁµêÁÆóÂçÄ
            const stats = calculateStats(player);

            // üéñÔ∏è Á∂ìÈ©óËàáÈáëÂπ£ÁµêÁÆó
            const expGain = Math.round(enemy.rewardExp);
            const gold = Math.floor(Math.random() * (enemy.rewardCoin[1] - enemy.rewardCoin[0] + 1)) + enemy.rewardCoin[0];
            const goldGain = Math.round(gold * stats.coinRate);

            // ÂØ¶ÈöõÂä†Âà∞Áé©ÂÆ∂Ë∫´‰∏ä
            player.gainExp(expGain);
            player.coin += goldGain;

            // üíé ÊéâÂØ∂ÁµêÁÆó
            const drop = getRandomDrop(enemy, stats.dropRate);
            const dropItem = drop ? drop.name : null;

            // ÂÑ≤Â≠òÁãÄÊÖã
            savePlayer();
            window.currentEnemy = null;

            // È°ØÁ§∫Êà∞È¨•ÁµêÊûúÁï´Èù¢
            iframe.srcdoc = `
    <html>
        <head>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        </head>
        <body style="font-family:sans-serif; text-align:center; background:#d1ffd1; min-height:100vh;">
            <div class="container">
                <h1>üèÜ Êà∞È¨•ÂãùÂà©ÔºÅ</h1>
                <p>‰Ω†ÊìäÊïó‰∫Ü <strong>${enemy.name}</strong></p>
                <p>Áç≤ÂæóÁ∂ìÈ©óÂÄºÔºö<strong>${expGain}</strong></p>
                <p>Áç≤ÂæóÈáëÂπ£Ôºö<strong>${goldGain}</strong></p>
                ${dropItem ? `<p>ÊéâËêΩÁâ©ÂìÅÔºö<strong>${dropItem}</strong></p>` : `<p>Ê≤íÊúâÊéâËêΩÁâ©ÂìÅ</p>`}
                <div class="fixed-bottom p-3 d-flex justify-content-center border-top" style="background:#d1ffd1">
                    <button class="btn btn-outline-primary me-3" onclick="parent.loadBattle(true)">ÁπºÁ∫åÊé¢Á¥¢</button>
                    <button class="btn btn-outline-success me-3" onclick="parent.loadInventory()">Áâ©ÂìÅÊ¨Ñ</button>
                    <button class="btn btn-primary" onclick="parent.loadTown()">ËøîÂõûÂüéÈéÆ</button>
                </div>
            </div>
        </body>
    </html>`;

            updateBars();
        }


        function runFromBattle() {

            window.currentEnemy = null;
            loadTown();
        }

        function loadBattle(newEncounter = false) {
            pauseTrainingOnSceneChange();
            const iframe = document.getElementById('gameFrame');
            let enemy = window.currentEnemy;

            // Âè™ÊúâÊñ∞‰∫ã‰ª∂ÊàñÊ≤íÊúâÊïµ‰∫∫ÊôÇÊâçÁîüÊàêÊïµ‰∫∫
            if (newEncounter || !enemy) {
                const rand = Math.random();
                if (rand < 0.7) {
                    // Êà∞È¨•‰∫ã‰ª∂
                    // atk: 5, def: 0, rewardExp: 20,
                    enemy = generateEnemy();


                    window.currentEnemy = enemy;
                } else if (rand < 0.9) {
                    // ÂØ∂ÁÆ±‰∫ã‰ª∂
                    const gold = Math.floor(Math.random() * 50) + 10;
                    player.coin += gold;
                    savePlayer();
                    iframe.srcdoc = `
            <html>
                <head>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                </head>
                <body style="font-family:sans-serif; text-align:center; background:#fff0f5; min-height:100vh;">
                    <div class="container">
                        <h1>üéÅ ‰Ω†ÊâæÂà∞‰∏ÄÂÄãÂØ∂ÁÆ±ÔºÅ</h1>
                        <p>Áç≤Âæó ${gold} ÈáëÂπ£ÔºÅ</p>
                          <div class="fixed-bottom  p-3 d-flex justify-content-center border-top"style="background:#fff0f5">
                            <button class="btn btn-outline-primary me-3" onclick="parent.loadBattle(true)">ÁπºÁ∫åÊé¢Á¥¢</button>
                            <button class="btn btn-outline-success me-3" onclick="parent.loadInventory()">Áâ©ÂìÅÊ¨Ñ</button>
                            <button class="btn btn-primary" onclick="parent.loadTown()">ËøîÂõûÂüéÈéÆ</button>
                        </div>
                    </div>
                </body>
            </html>`;
                    updateBars();
                    return;
                } else {
                    // Èô∑Èò±‰∫ã‰ª∂
                    const damage = Math.floor(Math.random() * 10) + 5;
                    player.currentHP = Math.max(0, player.currentHP - damage);
                    savePlayer();
                    iframe.srcdoc = `
            <html>
                <head>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                </head>
                <body style="font-family:sans-serif; text-align:center; background:#f0e68c; min-height:100vh;">
                    <div class="container">
                        <h1>üíÄ ‰Ω†Ë∏©Âà∞Èô∑Èò±ÔºÅ</h1>
                        <p>ÂèóÂà∞ ${damage} ÈªûÂÇ∑ÂÆ≥„ÄÇ</p>
                          <div class="fixed-bottom  p-3 d-flex justify-content-center border-top"style="background:#f0e68c;">
                            <button class="btn btn-outline-primary me-3" onclick="parent.loadBattle(true)">ÁπºÁ∫åÊé¢Á¥¢</button>
                            <button class="btn btn-outline-success me-3" onclick="parent.loadInventory()">Áâ©ÂìÅÊ¨Ñ</button>
                            <button class="btn btn-primary" onclick="parent.loadTown()">ËøîÂõûÂüéÈéÆ</button>

                        </div>
                    </div>
                </body>
            </html>`;
                    updateBars();
                    return;
                }
            }

            // Êà∞È¨•‰∏≠È°ØÁ§∫Êïµ‰∫∫ÁãÄÊÖã
            const content = `
<h1>‚öîÔ∏è ÈÅ≠ÈÅáÊïµ‰∫∫Ôºö${enemy.name}</h1>
<p>Êïµ‰∫∫ Á≠âÁ¥ö:${enemy.lvl}</p>
<p>Êïµ‰∫∫ HPÔºö${enemy.hp}</p>
<p>Êïµ‰∫∫ ÊîªÊìäÂäõÔºö${enemy.atk}</p>
<p>Êïµ‰∫∫ Èò≤Á¶¶ÂäõÔºö${enemy.def}</p>

<!-- ÊîªÊìäÂúñÁâáÂ±§ÊµÆÂú®‰∏äÈù¢ -->
<div id="img_atk" style="
  position:absolute;
  top:50%;
  left:0;
  right:0;
  transform:translateY(-50%);
  height:200px;
  z-index:9999;
  overflow:visible;
  pointer-events:none;
">

  <!-- Áé©ÂÆ∂ -->
  <div class="actor player" style="
    position:absolute;
    left:0;
    top:50%;
    transform:translateY(-50%);
  ">
    <img id="playerImg" src="${player.img}" style="
      display:block;
      width:150px;
      transition: transform 0.28s ease;
      transform: translateX(0);
      ">
      </div>
      
      <!-- Êïµ‰∫∫ -->
      <div class="actor enemy" style="
      position:absolute;
      right:0;
      top:50%;
      transform:translateY(-50%);
      ">
      <img id="enemyImg" src="${enemy.img}" style="
      display:block;
      height:150px;
      width:150px;
      transition: transform 0.28s ease;
      transform: translateX(0);
    ">
  </div>
</div>

<!-- Â∫ïÈÉ®Êìç‰ΩúÂàó -->
<div class="fixed-bottom p-3 d-flex justify-content-center border-top" 
  style="background:#f0e68c; z-index:2000;">
  <button class="btn btn-danger me-3" id="btnAttack" onclick="parent.attackEnemy()">ÊîªÊìä</button>
  <button class="btn btn-outline-success me-3" onclick="parent.loadInventory()">Áâ©ÂìÅÊ¨Ñ</button>
  <button class="btn btn-secondary me-3" id="btnRun" onclick="parent.runFromBattle()">ÈÄÉË∑ë</button>
</div>
`;

            iframe.srcdoc = `
        <html>
            <head>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            </head>
            <body style="font-family:sans-serif; text-align:center; background:#f0e68c; min-height:100vh;">
                <div class="container">${content}</div>
            </body>
        </html>`;

            updateBars();
            loadBattleSkillBar();
        }



        function cleardata() {
            localStorage.removeItem('playerData');
            location = ''
        }

        function savePlayer() {
            const data = {
                currentHP: player.currentHP,
                maxHP: player.maxHP,
                currentMP: player.currentMP,
                maxMP: player.maxMP,
                exp: player.exp,
                maxExp: player.maxExp,
                lvl: player.lvl,
                atk: player.atk,
                def: player.def,
                coin: player.coin,
                tasks: player.tasks,
                inventory: player.inventory,
                equipment: {
                    weapon: player.equipment.weapon,
                    armor: player.equipment.armor
                },
                talentSlots: player.talentSlots || [],
                statPoints: player.statPoints,
                totalStatPoints: player.totalStatPoints,
                statBonus: player.statBonus,
                skills: player.skills.map(skill => ({
                    name: skill.name,
                    lvl: skill.lvl || 1
                })),
                equipSkills: player.equipSkills || [],
            };
            localStorage.setItem('playerData', JSON.stringify(data));
        }

        function loadPlayer() {
            const data = JSON.parse(localStorage.getItem('playerData'));
            if (data) {
                player.currentHP = data.currentHP ?? player.currentHP;
                player.maxHP = data.maxHP ?? player.maxHP;
                player.currentMP = data.currentMP ?? player.currentMP;
                player.maxMP = data.maxMP ?? player.maxMP;
                player.exp = data.exp ?? player.exp;
                player.maxExp = data.maxExp ?? player.maxExp;
                player.lvl = data.lvl ?? player.lvl;
                player.atk = data.atk ?? player.atk;
                player.def = data.def ?? player.def;
                player.tasks = data.tasks || [];
                // ---- Êñ∞Â¢ûÔºöÊÅ¢Âæ©ÈáëÈå¢ËàáÁâ©ÂìÅÊ¨Ñ ----
                player.coin = data.coin ?? player.coin;
                player.inventory = data.inventory || player.inventory || [];
                // Ëã•Êúâ‰πãÂâçË£ùÂÇôÔºå‰πüÂèØÊÅ¢Âæ©ÔºàËã•‰Ω†ÊÉ≥ÂÑ≤Â≠òË£ùÂÇôÔºåÈúÄÂú® savePlayer ‰∏≠‰∏Ä‰ΩµÂÑ≤Â≠ò equipmentÔºâ
                if (data.equipment) {
                    player.equipment = data.equipment;
                }
                player.talentSlots = data.talentSlots || []
                player.statPoints = data.statPoints ?? player.statPoints;
                player.totalStatPoints = data.totalStatPoints ?? player.totalStatPoints;
                player.statBonus = data.statBonus || { atk: 0, def: 0, hp: 0, mp: 0 };
                player.skills = (data.skills || []).map(skill => ({
                    name: skill.name,
                    lvl: skill.lvl || 1
                }));
                player.equipSkills = data.equipSkills || [];
            }
            updateBars();
        }



        waitForJquery(() => {
            console.log(player);
            loadPlayer()
            // expadd()
            loadTown()
            loadBattleSkillBar()
            // player.addItem({ name: "ÁÅ´ÁêÉË°ìÊõ∏" });


        });




    </script>

</body>

</html>